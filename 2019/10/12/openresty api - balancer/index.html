<!DOCTYPE html>
<html  lang="zh-CN" >
    <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, maximum-scale=5, viewport-fit=cover">
    <title>OpenResty Api - balancer | 自留地</title>
    <meta name="description" content="一 概述如何使用 OpenResty 实现负载均衡模块？使用 balancer_by_lua_file|block 指令能够使用 Lua 实现负载均衡模块，在 Lua 代码中必须使用 ngx.balancer.set_current_peer 函数设置当前使用 server 地址端口。 OpenResty 使用 balancer_by_lua_file|block 指令修改 ngx_http_up">
<meta property="og:type" content="article">
<meta property="og:title" content="OpenResty Api - balancer">
<meta property="og:url" content="https://juzipeek.github.io/2019/10/12/openresty%20api%20-%20balancer/index.html">
<meta property="og:site_name" content="自留地">
<meta property="og:description" content="一 概述如何使用 OpenResty 实现负载均衡模块？使用 balancer_by_lua_file|block 指令能够使用 Lua 实现负载均衡模块，在 Lua 代码中必须使用 ngx.balancer.set_current_peer 函数设置当前使用 server 地址端口。 OpenResty 使用 balancer_by_lua_file|block 指令修改 ngx_http_up">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2019-10-11T16:00:00.000Z">
<meta property="article:modified_time" content="2022-09-03T17:44:11.322Z">
<meta property="article:author" content="zhou cheng jie">
<meta property="article:tag" content="NGINX">
<meta property="article:tag" content="C">
<meta property="article:tag" content="Lua">
<meta property="article:tag" content="OpenResty">
<meta name="twitter:card" content="summary">

    
    <link rel="icon" href="/images/favicon.ico" type="image/x-icon">

    
<link rel="stylesheet" href="/css/common.min.css">



    
    
    
    
        <link href="//cdn.jsdelivr.net/npm/lightgallery.js@1.1.3/dist/css/lightgallery.min.css" rel="stylesheet">
    
    
    
<link rel="stylesheet" href="/css/iconfont.min.css">

    
    <script>
        (function(e,t,n,i,s,a,c){e[n]=e[n]||function(){(e[n].q=e[n].q||[]).push(arguments)}
        ;a=t.createElement(i);c=t.getElementsByTagName(i)[0];a.async=true;a.src=s
        ;c.parentNode.insertBefore(a,c)
        })(window,document,"galite","script","https://cdn.jsdelivr.net/npm/ga-lite@2/dist/ga-lite.min.js");

        galite('create', 'G-HFGFGEWD53', 'auto');
        galite('send', 'pageview');
    </script>
    
<meta name="generator" content="Hexo 5.4.2"></head>

    <body>
        <header class="header header-fixture">
    <div class="profile-search-wrap flex sm:block">
        
        
        <div class="profile sm:text-center md:px-1 lg:px-3 sm:pb-4 sm:pt-6">
            <a id="avatar" role="link" href="https://github.com/juzipeek" class="inline-block lg:w-16 lg:h-16 w-8 h-8 m-2" target="_blank" rel="noopener" rel="noreferrer" >
                <img src="/images/yellow.jpg" class="rounded-full" alt="avatar">
            </a>
            <h2 id="name" class="hidden lg:block">zhou cheng jie</h2>
            <h3 id="title" class="hidden lg:block">coder</h3>
            
            <small id="location" class="hidden lg:block">
                <i class="iconfont icon-map-icon"></i>
                BeiJing, China
            </small>
            
        </div>
        
        
<div class="search flex-1 flex lg:inline-block sm:hidden lg:px-4 lg:mt-2 lg:mb-4 lg:w-full">
    <form id="search-form" class="my-auto flex-1 lg:border lg:border-solid lg:border-gray-200">
        <div class="input-group table bg-gray-100 lg:bg-white w-full">
            <input id="search-input" type="text" placeholder="搜索" class="inline-block w-full bg-gray-100 lg:bg-white p-1">
            <span class="table-cell">
                <button name="search tigger button" disabled>
                    <i class="iconfont icon-search m-2"></i>
                </button>
            </span>
        </div>
    </form>
        
<div id="content-json" data-placeholder="搜索" class="invisible hidden">/content.json</div>
<script id="search-teamplate" type="text/html" data-path="/content.json">
    <div>
        <div class="search-header bg-gray-400">
            <input id="actual-search-input" model="keyword" ref="input" class="inline-block w-full h-10 px-2 py-1" placeholder="搜索" type="text">
        </div>
        <div class="search-result bg-gray-200">
            {{#each searchPosts}}
            <a href="/{{ path }}" class="result-item block px-2 pb-3 mb-1 pt-1 hover:bg-indigo-100">
                <i class="iconfont icon-file"></i>
                <h1 class="result-title inline font-medium text-lg">{{ title }}</h1>
                <p class="result-content text-gray-600 text-sm">{{{ text }}}</p>
            </a>
            {{/each}}
        </div>
    </div>
</script>

</div>


        <button name="menu toogle button" id="menu-toggle-btn" class="block sm:hidden p-3" role="button" aria-expanded="false">
            <i class="iconfont icon-hamburger"></i>
        </button>
    </div>
    <nav id="menu-nav" class="hidden sm:flex flex-col">
        
        
            <div class="menu-item menu-home" role="menuitem">
                <a href="/.">
                    <i class="iconfont icon-home" aria-hidden="true"></i>
                    <span class="menu-title">首页</span>
                </a>
            </div>
        
        
            <div class="menu-item menu-archives" role="menuitem">
                <a href="/archives">
                    <i class="iconfont icon-archive" aria-hidden="true"></i>
                    <span class="menu-title">归档</span>
                </a>
            </div>
        
        
            <div class="menu-item menu-categories" role="menuitem">
                <a href="/categories">
                    <i class="iconfont icon-folder" aria-hidden="true"></i>
                    <span class="menu-title">分类</span>
                </a>
            </div>
        
        
            <div class="menu-item menu-tags" role="menuitem">
                <a href="/tags">
                    <i class="iconfont icon-tag" aria-hidden="true"></i>
                    <span class="menu-title">标签</span>
                </a>
            </div>
        
        
            <div class="menu-item menu-about" role="menuitem">
                <a href="/about">
                    <i class="iconfont icon-cup" aria-hidden="true"></i>
                    <span class="menu-title">关于</span>
                </a>
            </div>
        
        
<div class="social-links flex sm:flex-col lg:hidden mt-5">
    
        <span class="social-item text-center">
            <a target="_blank" rel="noopener" href="https://github.com/juzipeek">
                <i class="iconfont social-icon icon-github"></i>
                <span class="menu-title hidden lg:inline">menu.github</span>
            </a>
        </span>
    
</div>


    </nav>
</header>

        <section class="main-section">
            
    <main class="flex-1 px-4 py-14 md:px-5 lg:px-8 lg:py-4 relative min-h-screen">
    

    <article class="content article article-archives article-type-list" itemscope="">
        <header class="article-header">
            
    
        <h1 class="article-title text-lg" itemprop="name">
            OpenResty Api - balancer
        </h1>
    



            <p class="article-meta mb-3 text-xs">
                <span class="article-date">
    <i class="iconfont icon-calendar-check"></i>
	<a href="/2019/10/12/openresty%20api%20-%20balancer/" class="article-date">
	  <time datetime="2019-10-11T16:00:00.000Z" itemprop="datePublished">10月 12</time>
	</a>
</span>

                
    <span class="article-category">
    <i class="iconfont icon-folder"></i>
    <a class="article-category-link" href="/categories/NGINX/">NGINX</a>
  </span>


                
    <span class="article-tags">
    <i class="iconfont icon-tag"></i>
    <a class="article-tag-none-link" href="/tags/C/" rel="tag">C</a>, <a class="article-tag-none-link" href="/tags/Lua/" rel="tag">Lua</a>, <a class="article-tag-none-link" href="/tags/NGINX/" rel="tag">NGINX</a>, <a class="article-tag-none-link" href="/tags/OpenResty/" rel="tag">OpenResty</a>
  </span>


                <span class="_partial/post-comment"><i class="icon icon-comment"></i>
                    <a href="/2019/10/12/openresty%20api%20-%20balancer/#comments" class="article-comment-link">
                        评论
                    </a>
                </span>
                
    
        <span class="post-wordcount" itemprop="wordCount">字数统计: 2.4k(字)</span>
    
    
        <span class="post-readcount" itemprop="timeRequired">阅读时长: 12(分)</span>
    


            </p>
        </header>
        <div class="marked-body article-body">
            <h2 id="一-概述"><a href="#一-概述" class="headerlink" title="一 概述"></a>一 概述</h2><p>如何使用 OpenResty 实现负载均衡模块？使用 <code>balancer_by_lua_file|block</code> 指令能够使用 Lua 实现负载均衡模块，在 Lua 代码中必须使用 <code>ngx.balancer.set_current_peer</code> 函数设置当前使用 <code>server</code> 地址端口。</p>
<p>OpenResty 使用 <code>balancer_by_lua_file|block</code> 指令修改 <code>ngx_http_upstream_module</code> 模块的 <code>ngx_http_upstream_srv_conf_t::peer.init_upstream</code> 回调函数指针，在 upstream 初始化时会再次将当前 upstream 配置的 <code>ngx_http_upstream_srv_conf_t::peer.init</code> 回调函数指针修改，实现 <code>server</code> 获取释放（get/free）注入功能。</p>
<h2 id="二-指令"><a href="#二-指令" class="headerlink" title="二 指令"></a>二 指令</h2><h3 id="1-balancer-by-lua-block"><a href="#1-balancer-by-lua-block" class="headerlink" title="1. balancer_by_lua_block"></a>1. balancer_by_lua_block</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">syntax: <span class="section">balancer_by_lua_block</span> &#123; lua-<span class="attribute">script</span> &#125;</span><br><span class="line">context: upstream</span><br><span class="line">phase: content</span><br></pre></td></tr></table></figure>

<p>注入 Lua 代码块，实现负载均衡功能。<br><strong>如果 <code>lua-script</code> 处理失败会回退到 <code>round robin</code> 模块进行负载均衡处理</strong>。</p>
<h3 id="2-balancer-by-lua-file"><a href="#2-balancer-by-lua-file" class="headerlink" title="2. balancer_by_lua_file"></a>2. balancer_by_lua_file</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">syntax: <span class="attribute">balancer_by_lua_file</span> &lt;path-to-lua-file&gt;</span><br><span class="line">context: upstream</span><br><span class="line">phase: content</span><br></pre></td></tr></table></figure>

<p>注入 Lua 代码文件，实现负载均衡功能。</p>
<h2 id="三-函数"><a href="#三-函数" class="headerlink" title="三 函数"></a>三 函数</h2><h3 id="1-set-current-peer"><a href="#1-set-current-peer" class="headerlink" title="1. set_current_peer"></a>1. set_current_peer</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">syntax: ok, err = balancer.set_current_peer(host, port)</span><br><span class="line">context: balancer_by_lua*</span><br></pre></td></tr></table></figure>

<p>设置当前使用的 <code>server</code> 地址和端口。<br><strong>支持 <code>unix</code> 域地址，IPv4 和 IPv6，但是不支持域名</strong>。</p>
<h3 id="2-set-more-tries"><a href="#2-set-more-tries" class="headerlink" title="2. set_more_tries"></a>2. set_more_tries</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">syntax: ok, err = balancer.set_more_tries(count)</span><br><span class="line">context: balancer_by_lua*</span><br></pre></td></tr></table></figure>

<p>设置当前请求重试次数（不包含当前尝试）。<code>count</code> 不能大于 <code>proxy_next_upstream_tries</code> 设置值。</p>
<h3 id="3-get-last-failure"><a href="#3-get-last-failure" class="headerlink" title="3. get_last_failure"></a>3. get_last_failure</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">syntax: state_name, status_code = balancer.get_last_failure()</span><br><span class="line">context: balancer_by_lua*</span><br></pre></td></tr></table></figure>

<p>在触发重试机制时，查询先前失败的详细信息。如果有失败，则返回状态名称已经状态码。如果当前尝试是首次尝试，返回值为 <code>nil</code>。</p>
<h3 id="4-set-timeouts"><a href="#4-set-timeouts" class="headerlink" title="4. set_timeouts"></a>4. set_timeouts</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">syntax: ok, err = balancer.set_timeouts(connect_timeout, send_timeout, read_timeout)</span><br><span class="line">context: balancer_by_lua*</span><br></pre></td></tr></table></figure>

<p>设置当前和后续 upstream 连接的超时时间（连接超时，发送超时，读超时），以秒为单位精确到毫秒。<br><strong>超时时间必须大于零，不能等于零或小于零</strong>。</p>
<h2 id="四-实现"><a href="#四-实现" class="headerlink" title="四 实现"></a>四 实现</h2><h3 id="1-balancer-by-lua-block-file"><a href="#1-balancer-by-lua-block-file" class="headerlink" title="1. balancer_by_lua_block|file"></a>1. balancer_by_lua_block|file</h3><p>模块指令</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">ngx_command_t</span> ngx_http_lua_cmds[] = &#123;</span><br><span class="line">    ...</span><br><span class="line">    &#123; ngx_string(<span class="string">&quot;balancer_by_lua_file&quot;</span>),</span><br><span class="line">      NGX_HTTP_UPS_CONF|NGX_CONF_TAKE1,</span><br><span class="line">      ngx_http_lua_balancer_by_lua,</span><br><span class="line">      NGX_HTTP_SRV_CONF_OFFSET,</span><br><span class="line">      <span class="number">0</span>,</span><br><span class="line">      (<span class="type">void</span> *) ngx_http_lua_balancer_handler_file &#125;,</span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// balancer_by_lua 配置解析函数</span></span><br><span class="line"><span class="type">char</span> *</span><br><span class="line"><span class="title function_">ngx_http_lua_balancer_by_lua</span><span class="params">(<span class="type">ngx_conf_t</span> *cf, <span class="type">ngx_command_t</span> *cmd,</span></span><br><span class="line"><span class="params">    <span class="type">void</span> *conf)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line"> </span><br><span class="line">    value = cf-&gt;args-&gt;elts;</span><br><span class="line">    <span class="comment">// 设置处理函数指针</span></span><br><span class="line">    <span class="comment">// cmd-&gt;post 为 ngx_http_lua_balancer_handler_inline</span></span><br><span class="line">    lscf-&gt;balancer.handler = (ngx_http_lua_srv_conf_handler_pt) cmd-&gt;post;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (cmd-&gt;post == ngx_http_lua_balancer_handler_file) &#123;</span><br><span class="line">        <span class="comment">/* Lua code in an external file */</span></span><br><span class="line">		<span class="comment">// 外部 lua 文件</span></span><br><span class="line">		...</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">/* inlined Lua code */</span></span><br><span class="line">		<span class="comment">// 配置文件中 lua 代码</span></span><br><span class="line">		...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 修改 upstream 模块的 peer.init_upstream 指针，lua_module 介入处理</span></span><br><span class="line">    <span class="comment">// 跟踪代码可以发现，lua-nginx-module 只在请求的 peer.get/peer.free 介入处理</span></span><br><span class="line">    uscf = ngx_http_conf_get_module_srv_conf(cf, ngx_http_upstream_module);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (uscf-&gt;peer.init_upstream) &#123;</span><br><span class="line">        ngx_conf_log_error(NGX_LOG_WARN, cf, <span class="number">0</span>,</span><br><span class="line">                           <span class="string">&quot;load balancing method redefined&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    uscf-&gt;peer.init_upstream = ngx_http_lua_balancer_init;</span><br><span class="line"></span><br><span class="line">    uscf-&gt;flags = NGX_HTTP_UPSTREAM_CREATE</span><br><span class="line">                  |NGX_HTTP_UPSTREAM_WEIGHT</span><br><span class="line">                  |NGX_HTTP_UPSTREAM_MAX_FAILS</span><br><span class="line">                  |NGX_HTTP_UPSTREAM_FAIL_TIMEOUT</span><br><span class="line">                  |NGX_HTTP_UPSTREAM_DOWN;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_CONF_OK;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">ngx_int_t</span></span><br><span class="line"><span class="title function_">ngx_http_lua_balancer_init</span><span class="params">(<span class="type">ngx_conf_t</span> *cf,</span></span><br><span class="line"><span class="params">    <span class="type">ngx_http_upstream_srv_conf_t</span> *us)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (ngx_http_upstream_init_round_robin(cf, us) != NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* this callback is called upon individual requests */</span></span><br><span class="line">    us-&gt;peer.init = ngx_http_lua_balancer_init_peer;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">ngx_int_t</span></span><br><span class="line"><span class="title function_">ngx_http_lua_balancer_init_peer</span><span class="params">(<span class="type">ngx_http_request_t</span> *r,</span></span><br><span class="line"><span class="params">    <span class="type">ngx_http_upstream_srv_conf_t</span> *us)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">ngx_http_lua_srv_conf_t</span>            *bcf;</span><br><span class="line">    <span class="type">ngx_http_lua_balancer_peer_data_t</span>  *bp;</span><br><span class="line"></span><br><span class="line">    bp = ngx_pcalloc(r-&gt;pool, <span class="keyword">sizeof</span>(<span class="type">ngx_http_lua_balancer_peer_data_t</span>));</span><br><span class="line">    <span class="keyword">if</span> (bp == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    r-&gt;upstream-&gt;peer.data = &amp;bp-&gt;rrp;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_http_upstream_init_round_robin_peer(r, us) != NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    r-&gt;upstream-&gt;peer.get = ngx_http_lua_balancer_get_peer;</span><br><span class="line">    r-&gt;upstream-&gt;peer.<span class="built_in">free</span> = ngx_http_lua_balancer_free_peer;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    bcf = ngx_http_conf_upstream_srv_conf(us, ngx_http_lua_module);</span><br><span class="line"></span><br><span class="line">    bp-&gt;conf = bcf;</span><br><span class="line">    bp-&gt;request = r;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-ngx-balancer-set-current-peer"><a href="#2-ngx-balancer-set-current-peer" class="headerlink" title="2. ngx.balancer.set_current_peer"></a>2. ngx.balancer.set_current_peer</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">syntax: ok, err = balancer.set_current_peer(host, port)</span><br><span class="line"></span><br><span class="line">context: balancer_by_lua*</span><br></pre></td></tr></table></figure>

<p>用于设置后端地址、端口, <strong>不能使用域名</strong>.</p>
<p>在 lua-nginx-module 模块中 <code>set_current_peer</code> 通过修改 UPSTREAM 配置中 <code>balancer_peer_data</code> 字段达到目的. 看代码, <code>set_current_peer</code> 并没有直接修改 <code>r-&gt;upstream-&gt;peer.data</code> 字段, 是因为需要与其他 UPSTREAM 模块配合, 避免被修改.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">ngx_http_lua_ffi_balancer_set_current_peer</span><span class="params">(<span class="type">ngx_http_request_t</span> *r,</span></span><br><span class="line"><span class="params">    <span class="type">const</span> u_char *addr, <span class="type">size_t</span> addr_len, <span class="type">int</span> port, <span class="type">char</span> **err)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    ctx = ngx_http_get_module_ctx(r, ngx_http_lua_module);</span><br><span class="line">	...</span><br><span class="line">    lmcf = ngx_http_get_module_main_conf(r, ngx_http_lua_module);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 不直接修改 peer.data 的原因:</span></span><br><span class="line">    <span class="comment">/* we cannot read r-&gt;upstream-&gt;peer.data here directly because</span></span><br><span class="line"><span class="comment">     * it could be overridden by other modules like</span></span><br><span class="line"><span class="comment">     * ngx_http_upstream_keepalive_module.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    bp = lmcf-&gt;balancer_peer_data;</span><br><span class="line">    <span class="keyword">if</span> (bp == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        *err = <span class="string">&quot;no upstream peer data found&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_memzero(&amp;url, <span class="keyword">sizeof</span>(<span class="type">ngx_url_t</span>));</span><br><span class="line"></span><br><span class="line">    url.url.data = ngx_palloc(r-&gt;pool, addr_len);</span><br><span class="line">    <span class="keyword">if</span> (url.url.data == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        *err = <span class="string">&quot;no memory&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_memcpy(url.url.data, addr, addr_len);</span><br><span class="line"></span><br><span class="line">    url.url.len = addr_len;</span><br><span class="line">    url.default_port = (<span class="type">in_port_t</span>) port;</span><br><span class="line">    url.uri_part = <span class="number">0</span>;</span><br><span class="line">    url.no_resolve = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ngx_parse_url(r-&gt;pool, &amp;url) != NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">if</span> (url.err) &#123;</span><br><span class="line">            *err = url.err;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置转发后端地址</span></span><br><span class="line">    <span class="keyword">if</span> (url.addrs &amp;&amp; url.addrs[<span class="number">0</span>].sockaddr) &#123;</span><br><span class="line">        bp-&gt;sockaddr = url.addrs[<span class="number">0</span>].sockaddr;</span><br><span class="line">        bp-&gt;socklen = url.addrs[<span class="number">0</span>].socklen;</span><br><span class="line">        bp-&gt;host = &amp;url.addrs[<span class="number">0</span>].name;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        *err = <span class="string">&quot;no host allowed&quot;</span>;</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> <strong>后端信息通过 ngx_http_lua_module 模块配置中 <code>balancer_peer_data</code> 字段暂存</strong>. 看代码中注释, <strong>balancer_peer_data</strong> 在 balancer 阶段只会被一个请求修改, 不会有竞争状态.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">ngx_http_lua_main_conf_s</span>  <span class="title">ngx_http_lua_main_conf_t</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ngx_http_lua_main_conf_s</span> &#123;</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="type">ngx_http_lua_balancer_peer_data_t</span>      *balancer_peer_data;</span><br><span class="line">                    <span class="comment">/* neither yielding nor recursion is possible in</span></span><br><span class="line"><span class="comment">                     * balancer_by_lua*, so there cannot be any races among</span></span><br><span class="line"><span class="comment">                     * concurrent requests and it is safe to store the peer</span></span><br><span class="line"><span class="comment">                     * data pointer in the main conf.</span></span><br><span class="line"><span class="comment">                     */</span></span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="3-ngx-balancer-set-current-peer-NGINX-原生"><a href="#3-ngx-balancer-set-current-peer-NGINX-原生" class="headerlink" title="3. ngx.balancer.set_current_peer NGINX 原生"></a>3. ngx.balancer.set_current_peer NGINX 原生</h3><p>在 NGINX UPSTREAM 处理框架中, <code>ngx_http_upstream_connect</code> 函数会调用 <code>ngx_event_connect_peer</code> 进行连接处理, 会调用 lua-nginx 模块设置的回调函数, 读取 <code>bp</code> 中的内容, 进行后端地址设置; 使用非阻塞连接方式建立连接, 使用 epoll 模块时会对连接同时添加读/写事件监听. </p>
<p><strong>非阻塞连接, 连接建立成功时会是可写状态, 失败时是可读、可写状态. 需要通过调用 getsockopt 函数, 判断 socket 是否有错误.</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">ngx_http_upstream_connect</span><span class="params">(<span class="type">ngx_http_request_t</span> *r, <span class="type">ngx_http_upstream_t</span> *u)</span></span><br><span class="line">&#123;</span><br><span class="line">    r-&gt;connection-&gt;<span class="built_in">log</span>-&gt;action = <span class="string">&quot;connecting to upstream&quot;</span>;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 状态设置</span></span><br><span class="line">    u-&gt;state-&gt;response_time = ngx_current_msec;</span><br><span class="line">    u-&gt;state-&gt;connect_time = (<span class="type">ngx_msec_t</span>) <span class="number">-1</span>;</span><br><span class="line">    u-&gt;state-&gt;header_time = (<span class="type">ngx_msec_t</span>) <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 作为客户端发起与上游连接</span></span><br><span class="line">    rc = ngx_event_connect_peer(&amp;u-&gt;peer);</span><br><span class="line"></span><br><span class="line">    ngx_log_debug1(NGX_LOG_DEBUG_HTTP, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">&quot;http upstream connect: %i&quot;</span>, rc);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 错误处理</span></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* rc == NGX_OK || rc == NGX_AGAIN || rc == NGX_DONE */</span></span><br><span class="line"></span><br><span class="line">    c = u-&gt;peer.connection;</span><br><span class="line"></span><br><span class="line">    c-&gt;data = r;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 事件回调函数设置</span></span><br><span class="line">    c-&gt;write-&gt;handler = ngx_http_upstream_handler;</span><br><span class="line">    c-&gt;read-&gt;handler = ngx_http_upstream_handler;</span><br><span class="line"></span><br><span class="line">    u-&gt;write_event_handler = ngx_http_upstream_send_request_handler;</span><br><span class="line">    u-&gt;read_event_handler = ngx_http_upstream_process_header;</span><br><span class="line"></span><br><span class="line">    c-&gt;sendfile &amp;= r-&gt;connection-&gt;sendfile;</span><br><span class="line">    u-&gt;output.sendfile = c-&gt;sendfile;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 设置连接超时时间</span></span><br><span class="line">    <span class="comment">// u-&gt;conf 实际指向的是 lua-nginx 模块创建的临时内存</span></span><br><span class="line">    <span class="keyword">if</span> (rc == NGX_AGAIN) &#123;</span><br><span class="line">        ngx_add_timer(c-&gt;write, u-&gt;conf-&gt;connect_timeout);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">    ngx_http_upstream_send_request(r, u, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>连接操作:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ngx_int_t</span></span><br><span class="line"><span class="title function_">ngx_event_connect_peer</span><span class="params">(<span class="type">ngx_peer_connection_t</span> *pc)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span>                rc, type;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> (NGX_HAVE_IP_BIND_ADDRESS_NO_PORT || NGX_LINUX)</span></span><br><span class="line">    <span class="type">in_port_t</span>          port;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="type">ngx_int_t</span>          event;</span><br><span class="line">    <span class="type">ngx_err_t</span>          err;</span><br><span class="line">    <span class="type">ngx_uint_t</span>         level;</span><br><span class="line">    <span class="type">ngx_socket_t</span>       s;</span><br><span class="line">    <span class="type">ngx_event_t</span>       *rev, *wev;</span><br><span class="line">    <span class="type">ngx_connection_t</span>  *c;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用 lua-nginx 模块回调函数</span></span><br><span class="line">    <span class="comment">// pc-&gt;get 指向 ngx_http_lua_balancer_get_peer 函数</span></span><br><span class="line">    rc = pc-&gt;get(pc, pc-&gt;data);</span><br><span class="line">    <span class="keyword">if</span> (rc != NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> rc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    c = ngx_get_connection(s, pc-&gt;<span class="built_in">log</span>);</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将 socket 设置为非阻塞模式</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_nonblocking(s) == <span class="number">-1</span>) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_ALERT, pc-&gt;<span class="built_in">log</span>, ngx_socket_errno,</span><br><span class="line">                      ngx_nonblocking_n <span class="string">&quot; failed&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">goto</span> failed;</span><br><span class="line">    &#125;</span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// epoll 模块有 ngx_add_conn 函数, 为 ngx_epoll_add_connection</span></span><br><span class="line">    <span class="comment">// 会添加连接的读、写事件监听</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_add_conn) &#123;</span><br><span class="line">        <span class="keyword">if</span> (ngx_add_conn(c) == NGX_ERROR) &#123;</span><br><span class="line">            <span class="keyword">goto</span> failed;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用 connect</span></span><br><span class="line">    rc = connect(s, pc-&gt;sockaddr, pc-&gt;socklen);</span><br><span class="line"></span><br><span class="line">    ... <span class="comment">// 错误处理</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// epoll 模块有 ngx_add_conn 函数</span></span><br><span class="line">    <span class="keyword">if</span> (ngx_add_conn) &#123;</span><br><span class="line">        <span class="keyword">if</span> (rc == <span class="number">-1</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/* NGX_EINPROGRESS */</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> NGX_AGAIN;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ngx_log_debug0(NGX_LOG_DEBUG_EVENT, pc-&gt;<span class="built_in">log</span>, <span class="number">0</span>, <span class="string">&quot;connected&quot;</span>);</span><br><span class="line"></span><br><span class="line">        wev-&gt;ready = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 非 Linux 平台处理</span></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// epoll 事件模块, 添加连接</span></span><br><span class="line"><span class="type">static</span> <span class="type">ngx_int_t</span></span><br><span class="line"><span class="title function_">ngx_epoll_add_connection</span><span class="params">(<span class="type">ngx_connection_t</span> *c)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">epoll_event</span>  <span class="title">ee</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 监听读、写事件</span></span><br><span class="line">    ee.events = EPOLLIN|EPOLLOUT|EPOLLET|EPOLLRDHUP;</span><br><span class="line">    ee.data.ptr = (<span class="type">void</span> *) ((<span class="type">uintptr_t</span>) c | c-&gt;read-&gt;instance);</span><br><span class="line"></span><br><span class="line">    ngx_log_debug2(NGX_LOG_DEBUG_EVENT, c-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">&quot;epoll add connection: fd:%d ev:%08XD&quot;</span>, c-&gt;fd, ee.events);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (epoll_ctl(ep, EPOLL_CTL_ADD, c-&gt;fd, &amp;ee) == <span class="number">-1</span>) &#123;</span><br><span class="line">        ngx_log_error(NGX_LOG_ALERT, c-&gt;<span class="built_in">log</span>, ngx_errno,</span><br><span class="line">                      <span class="string">&quot;epoll_ctl(EPOLL_CTL_ADD, %d) failed&quot;</span>, c-&gt;fd);</span><br><span class="line">        <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    c-&gt;read-&gt;active = <span class="number">1</span>;</span><br><span class="line">    c-&gt;write-&gt;active = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="4-ngx-balancer-set-timeouts"><a href="#4-ngx-balancer-set-timeouts" class="headerlink" title="4. ngx.balancer.set_timeouts"></a>4. ngx.balancer.set_timeouts</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">syntax: ok, err = balancer.set_timeouts(connect_timeout, send_timeout, read_timeout)</span><br><span class="line"></span><br><span class="line">context: balancer_by_lua*</span><br></pre></td></tr></table></figure>

<p>超时时间设置与后端地址设置有所不同, <strong>每个请求会创建独立的 UPSTREAM CONF 结构, 确保请求间超时时间独立.</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span></span><br><span class="line"><span class="title function_">ngx_http_lua_ffi_balancer_set_timeouts</span><span class="params">(<span class="type">ngx_http_request_t</span> *r,</span></span><br><span class="line"><span class="params">    <span class="type">long</span> connect_timeout, <span class="type">long</span> send_timeout, <span class="type">long</span> read_timeout,</span></span><br><span class="line"><span class="params">    <span class="type">char</span> **err)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">ngx_http_lua_ctx_t</span>    *ctx;</span><br><span class="line">    <span class="type">ngx_http_upstream_t</span>   *u;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !(HAVE_NGX_UPSTREAM_TIMEOUT_FIELDS)</span></span><br><span class="line">    <span class="type">ngx_http_upstream_conf_t</span>           *ucf;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="type">ngx_http_lua_main_conf_t</span>           *lmcf;</span><br><span class="line">    <span class="type">ngx_http_lua_balancer_peer_data_t</span>  *bp;</span><br><span class="line">	...</span><br><span class="line">    u = r-&gt;upstream;</span><br><span class="line"></span><br><span class="line">    ctx = ngx_http_get_module_ctx(r, ngx_http_lua_module);</span><br><span class="line">    ...</span><br><span class="line">    lmcf = ngx_http_get_module_main_conf(r, ngx_http_lua_module);</span><br><span class="line"></span><br><span class="line">    bp = lmcf-&gt;balancer_peer_data;</span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建独立的 upstream conf 内存, 每个请求都可以有独立的超时时间</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !(HAVE_NGX_UPSTREAM_TIMEOUT_FIELDS)</span></span><br><span class="line">    <span class="keyword">if</span> (!bp-&gt;cloned_upstream_conf) &#123;</span><br><span class="line">        <span class="comment">/* we clone the upstream conf for the current request so that</span></span><br><span class="line"><span class="comment">         * we do not affect other requests at all. */</span></span><br><span class="line"></span><br><span class="line">        ucf = ngx_palloc(r-&gt;pool, <span class="keyword">sizeof</span>(<span class="type">ngx_http_upstream_conf_t</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ucf == <span class="literal">NULL</span>) &#123;</span><br><span class="line">            *err = <span class="string">&quot;no memory&quot;</span>;</span><br><span class="line">            <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ngx_memcpy(ucf, u-&gt;conf, <span class="keyword">sizeof</span>(<span class="type">ngx_http_upstream_conf_t</span>));</span><br><span class="line"></span><br><span class="line">        u-&gt;conf = ucf;</span><br><span class="line">        bp-&gt;cloned_upstream_conf = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ucf = u-&gt;conf;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (connect_timeout &gt; <span class="number">0</span>) &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> (HAVE_NGX_UPSTREAM_TIMEOUT_FIELDS)</span></span><br><span class="line">        u-&gt;connect_timeout = (<span class="type">ngx_msec_t</span>) connect_timeout;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">        ucf-&gt;connect_timeout = (<span class="type">ngx_msec_t</span>) connect_timeout;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-ngx-balancer-set-more-tries"><a href="#5-ngx-balancer-set-more-tries" class="headerlink" title="5. ngx.balancer.set_more_tries"></a>5. ngx.balancer.set_more_tries</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">syntax: ok, err = balancer.set_more_tries(count)</span><br><span class="line"></span><br><span class="line">context: balancer_by_lua*</span><br></pre></td></tr></table></figure>

<p>设置允许重试次数, 最大重试次数受限于 <code>proxy_next_upstream_tries</code> 配置项.</p>
<p>NGINX 中重试是通过 <code>ngx_http_upstream_next</code> 函数实现, 是否允许重试需要同时考虑允许重试状态码、超时时间以及重试次数, 当超过重试次数时直接给客户端响应. 允许重试是通过递减允许重试次数, 当允许重试次数为零时, 不允许进行重试.  ngx_peer_connection_t::tries 为允许重试次数.</p>
<p>UPSTREAM 处理框架中有 <code>peer.get</code>, <code>peer.free</code> 分别用于后端地址获取、释放. 在获取时设置允许重试次数(根据用户 lua 代码更新), 释放时重试次数减一.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">ngx_int_t</span></span><br><span class="line"><span class="title function_">ngx_http_lua_balancer_init_peer</span><span class="params">(<span class="type">ngx_http_request_t</span> *r,</span></span><br><span class="line"><span class="params">    <span class="type">ngx_http_upstream_srv_conf_t</span> *us)</span></span><br><span class="line">&#123;</span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取后端地址</span></span><br><span class="line">    r-&gt;upstream-&gt;peer.get = ngx_http_lua_balancer_get_peer;</span><br><span class="line">    <span class="comment">// 释放后端地址</span></span><br><span class="line">    r-&gt;upstream-&gt;peer.<span class="built_in">free</span> = ngx_http_lua_balancer_free_peer;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>获取:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">ngx_int_t</span></span><br><span class="line"><span class="title function_">ngx_http_lua_balancer_get_peer</span><span class="params">(<span class="type">ngx_peer_connection_t</span> *pc, <span class="type">void</span> *data)</span></span><br><span class="line">&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// 运行 lua 代码</span></span><br><span class="line">    rc = lscf-&gt;balancer.handler(r, lscf, L);</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (bp-&gt;sockaddr &amp;&amp; bp-&gt;socklen) &#123;</span><br><span class="line">        pc-&gt;sockaddr = bp-&gt;sockaddr;</span><br><span class="line">        pc-&gt;socklen = bp-&gt;socklen;</span><br><span class="line">        pc-&gt;cached = <span class="number">0</span>;</span><br><span class="line">        pc-&gt;connection = <span class="literal">NULL</span>;</span><br><span class="line">        pc-&gt;name = bp-&gt;host;</span><br><span class="line"></span><br><span class="line">        bp-&gt;rrp.peers-&gt;single = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果有设置重试次数, 更新允许重试次数</span></span><br><span class="line">        <span class="keyword">if</span> (bp-&gt;more_tries) &#123;</span><br><span class="line">            r-&gt;upstream-&gt;peer.tries += bp-&gt;more_tries;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        dd(<span class="string">&quot;tries: %d&quot;</span>, (<span class="type">int</span>) r-&gt;upstream-&gt;peer.tries);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ngx_http_upstream_get_round_robin_peer(pc, &amp;bp-&gt;rrp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>释放:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span></span><br><span class="line"><span class="title function_">ngx_http_lua_balancer_free_peer</span><span class="params">(<span class="type">ngx_peer_connection_t</span> *pc, <span class="type">void</span> *data,</span></span><br><span class="line"><span class="params">    <span class="type">ngx_uint_t</span> state)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">ngx_http_lua_balancer_peer_data_t</span>  *bp = data;</span><br><span class="line"></span><br><span class="line">    ngx_log_debug1(NGX_LOG_DEBUG_HTTP, pc-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">&quot;lua balancer free peer, tries: %ui&quot;</span>, pc-&gt;tries);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (bp-&gt;sockaddr &amp;&amp; bp-&gt;socklen) &#123;</span><br><span class="line">        bp-&gt;last_peer_state = (<span class="type">int</span>) state;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (pc-&gt;tries) &#123;</span><br><span class="line">            <span class="comment">// 重试次数减一</span></span><br><span class="line">            pc-&gt;tries--;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* fallback */</span></span><br><span class="line"></span><br><span class="line">    ngx_http_upstream_free_round_robin_peer(pc, data, state);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在与后端 connect、send_request、process_header 出错时会调用失败重试判断函数 <code>ngx_http_upstream_next</code>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">ngx_http_upstream_next</span><span class="params">(<span class="type">ngx_http_request_t</span> *r, <span class="type">ngx_http_upstream_t</span> *u,</span></span><br><span class="line"><span class="params">    <span class="type">ngx_uint_t</span> ft_type)</span></span><br><span class="line">&#123;</span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (u-&gt;peer.sockaddr) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ft_type == NGX_HTTP_UPSTREAM_FT_HTTP_403</span><br><span class="line">            || ft_type == NGX_HTTP_UPSTREAM_FT_HTTP_404)</span><br><span class="line">        &#123;</span><br><span class="line">            state = NGX_PEER_NEXT;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            state = NGX_PEER_FAILED;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 调用 peer.free 触发重试次数减一</span></span><br><span class="line">        u-&gt;peer.<span class="built_in">free</span>(&amp;u-&gt;peer, u-&gt;peer.data, state);</span><br><span class="line">        u-&gt;peer.sockaddr = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 允许重试次数为零时, 请求处理结束</span></span><br><span class="line">    <span class="keyword">if</span> (u-&gt;peer.tries == <span class="number">0</span></span><br><span class="line">        || ((u-&gt;conf-&gt;next_upstream &amp; ft_type) != ft_type)</span><br><span class="line">        || (u-&gt;request_sent &amp;&amp; r-&gt;request_body_no_buffering)</span><br><span class="line">        || (timeout &amp;&amp; ngx_current_msec - u-&gt;peer.start_time &gt;= timeout))</span><br><span class="line">    &#123;</span><br><span class="line">		...</span><br><span class="line">        ngx_http_upstream_finalize_request(r, u, status);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 重新回到连接阶段</span></span><br><span class="line">    ngx_http_upstream_connect(r, u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

        </div>
        

    </article>
    
    <section id="comments">
        
    </section>


    

</main>


<aside style="" id="sidebar" class="aside aside-fixture">
    <div class="toc-sidebar">
        <nav id="toc" class="article-toc">
            <h3 class="toc-title">文章目录</h3>
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80-%E6%A6%82%E8%BF%B0"><span class="toc-number">1.</span> <span class="toc-text">一 概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C-%E6%8C%87%E4%BB%A4"><span class="toc-number">2.</span> <span class="toc-text">二 指令</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-balancer-by-lua-block"><span class="toc-number">2.1.</span> <span class="toc-text">1. balancer_by_lua_block</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-balancer-by-lua-file"><span class="toc-number">2.2.</span> <span class="toc-text">2. balancer_by_lua_file</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89-%E5%87%BD%E6%95%B0"><span class="toc-number">3.</span> <span class="toc-text">三 函数</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-set-current-peer"><span class="toc-number">3.1.</span> <span class="toc-text">1. set_current_peer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-set-more-tries"><span class="toc-number">3.2.</span> <span class="toc-text">2. set_more_tries</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-get-last-failure"><span class="toc-number">3.3.</span> <span class="toc-text">3. get_last_failure</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-set-timeouts"><span class="toc-number">3.4.</span> <span class="toc-text">4. set_timeouts</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B-%E5%AE%9E%E7%8E%B0"><span class="toc-number">4.</span> <span class="toc-text">四 实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-balancer-by-lua-block-file"><span class="toc-number">4.1.</span> <span class="toc-text">1. balancer_by_lua_block|file</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-ngx-balancer-set-current-peer"><span class="toc-number">4.2.</span> <span class="toc-text">2. ngx.balancer.set_current_peer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-ngx-balancer-set-current-peer-NGINX-%E5%8E%9F%E7%94%9F"><span class="toc-number">4.3.</span> <span class="toc-text">3. ngx.balancer.set_current_peer NGINX 原生</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-ngx-balancer-set-timeouts"><span class="toc-number">4.4.</span> <span class="toc-text">4. ngx.balancer.set_timeouts</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-ngx-balancer-set-more-tries"><span class="toc-number">4.5.</span> <span class="toc-text">5. ngx.balancer.set_more_tries</span></a></li></ol></li></ol>
        </nav>
    </div>
</aside>





        </section>
        <footer class="hidden lg:block fixed bottom-0 left-0 sm:w-1/12 lg:w-1/6 bg-gray-100 z-40">
    
    <div class="footer-social-links">
        
            <a target="_blank" rel="noopener" href="https://github.com/juzipeek">
                <i class="iconfont icon-github"></i>
            </a>
        
    </div>
    
    
</footer>

        <div id="mask" class="hidden mask fixed inset-0 bg-gray-900 opacity-75 z-40"></div>
        <div id="search-view-container" class="hidden shadow-xl"></div>
        
<script src="/js/dom-event.min.js"></script>



<script src="/js/local-search.min.js"></script>



    <script src="//cdn.jsdelivr.net/npm/lightgallery.js@1.1.3/dist/js/lightgallery.min.js"></script>
    
<script src="/js/light-gallery.min.js"></script>






    </body>
</html>
