<!DOCTYPE html>
<html  lang="zh-CN" >
    <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, maximum-scale=5, viewport-fit=cover">
    <title>libco 代码阅读 | 自说自话</title>
    <meta name="description" content="libco 代码阅读">
<meta property="og:type" content="article">
<meta property="og:title" content="libco 代码阅读">
<meta property="og:url" content="https://juzipeek.github.io/2020/01/02/libco/index.html">
<meta property="og:site_name" content="自说自话">
<meta property="og:description" content="libco 代码阅读">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2020-01-01T16:00:00.000Z">
<meta property="article:modified_time" content="2022-09-03T17:44:11.302Z">
<meta property="article:author" content="zhou cheng jie">
<meta property="article:tag" content="C">
<meta property="article:tag" content="asm">
<meta property="article:tag" content="coroutine">
<meta name="twitter:card" content="summary">

    
    <link rel="icon" href="/images/favicon.ico" type="image/x-icon">

    
<link rel="stylesheet" href="/css/common.min.css">



    
    
    
    
        <link href="//cdn.jsdelivr.net/npm/lightgallery.js@1.1.3/dist/css/lightgallery.min.css" rel="stylesheet">
    
    
    
<link rel="stylesheet" href="/css/iconfont.min.css">

    
    <script>
        (function(e,t,n,i,s,a,c){e[n]=e[n]||function(){(e[n].q=e[n].q||[]).push(arguments)}
        ;a=t.createElement(i);c=t.getElementsByTagName(i)[0];a.async=true;a.src=s
        ;c.parentNode.insertBefore(a,c)
        })(window,document,"galite","script","https://cdn.jsdelivr.net/npm/ga-lite@2/dist/ga-lite.min.js");

        galite('create', 'G-HFGFGEWD53', 'auto');
        galite('send', 'pageview');
    </script>
    
<meta name="generator" content="Hexo 5.4.2"></head>

    <body>
        <header class="header header-fixture">
    <div class="profile-search-wrap flex sm:block">
        
        
        <div class="profile sm:text-center md:px-1 lg:px-3 sm:pb-4 sm:pt-6">
            <a id="avatar" role="link" href="https://github.com/juzipeek" class="inline-block lg:w-16 lg:h-16 w-8 h-8 m-2" target="_blank" rel="noopener" rel="noreferrer" >
                <img src="/images/yellow.jpg" class="rounded-full" alt="avatar">
            </a>
            <h2 id="name" class="hidden lg:block">zhou cheng jie</h2>
            <h3 id="title" class="hidden lg:block">coder</h3>
            
            <small id="location" class="hidden lg:block">
                <i class="iconfont icon-map-icon"></i>
                BeiJing, China
            </small>
            
        </div>
        
        
<div class="search flex-1 flex lg:inline-block sm:hidden lg:px-4 lg:mt-2 lg:mb-4 lg:w-full">
    <form id="search-form" class="my-auto flex-1 lg:border lg:border-solid lg:border-gray-200">
        <div class="input-group table bg-gray-100 lg:bg-white w-full">
            <input id="search-input" type="text" placeholder="搜索" class="inline-block w-full bg-gray-100 lg:bg-white p-1">
            <span class="table-cell">
                <button name="search tigger button" disabled>
                    <i class="iconfont icon-search m-2"></i>
                </button>
            </span>
        </div>
    </form>
        
<div id="content-json" data-placeholder="搜索" class="invisible hidden">/content.json</div>
<script id="search-teamplate" type="text/html" data-path="/content.json">
    <div>
        <div class="search-header bg-gray-400">
            <input id="actual-search-input" model="keyword" ref="input" class="inline-block w-full h-10 px-2 py-1" placeholder="搜索" type="text">
        </div>
        <div class="search-result bg-gray-200">
            {{#each searchPosts}}
            <a href="/{{ path }}" class="result-item block px-2 pb-3 mb-1 pt-1 hover:bg-indigo-100">
                <i class="iconfont icon-file"></i>
                <h1 class="result-title inline font-medium text-lg">{{ title }}</h1>
                <p class="result-content text-gray-600 text-sm">{{{ text }}}</p>
            </a>
            {{/each}}
        </div>
    </div>
</script>

</div>


        <button name="menu toogle button" id="menu-toggle-btn" class="block sm:hidden p-3" role="button" aria-expanded="false">
            <i class="iconfont icon-hamburger"></i>
        </button>
    </div>
    <nav id="menu-nav" class="hidden sm:flex flex-col">
        
        
            <div class="menu-item menu-home" role="menuitem">
                <a href="/.">
                    <i class="iconfont icon-home" aria-hidden="true"></i>
                    <span class="menu-title">首页</span>
                </a>
            </div>
        
        
            <div class="menu-item menu-archives" role="menuitem">
                <a href="/archives">
                    <i class="iconfont icon-archive" aria-hidden="true"></i>
                    <span class="menu-title">归档</span>
                </a>
            </div>
        
        
            <div class="menu-item menu-categories" role="menuitem">
                <a href="/categories">
                    <i class="iconfont icon-folder" aria-hidden="true"></i>
                    <span class="menu-title">分类</span>
                </a>
            </div>
        
        
            <div class="menu-item menu-tags" role="menuitem">
                <a href="/tags">
                    <i class="iconfont icon-tag" aria-hidden="true"></i>
                    <span class="menu-title">标签</span>
                </a>
            </div>
        
        
            <div class="menu-item menu-about" role="menuitem">
                <a href="/about">
                    <i class="iconfont icon-cup" aria-hidden="true"></i>
                    <span class="menu-title">关于</span>
                </a>
            </div>
        
        
<div class="social-links flex sm:flex-col lg:hidden mt-5">
    
        <span class="social-item text-center">
            <a target="_blank" rel="noopener" href="https://github.com/juzipeek">
                <i class="iconfont social-icon icon-github"></i>
                <span class="menu-title hidden lg:inline">menu.github</span>
            </a>
        </span>
    
</div>


    </nav>
</header>

        <section class="main-section">
            
    <main class="flex-1 px-4 py-14 md:px-5 lg:px-8 lg:py-4 relative min-h-screen">
    

    <article class="content article article-archives article-type-list" itemscope="">
        <header class="article-header">
            
    
        <h1 class="article-title text-lg" itemprop="name">
            libco 代码阅读
        </h1>
    



            <p class="article-meta mb-3 text-xs">
                <span class="article-date">
    <i class="iconfont icon-calendar-check"></i>
	<a href="/2020/01/02/libco/" class="article-date">
	  <time datetime="2020-01-01T16:00:00.000Z" itemprop="datePublished">1月 2</time>
	</a>
</span>

                
    <span class="article-category">
    <i class="iconfont icon-folder"></i>
    <a class="article-category-link" href="/categories/C/">C</a>
  </span>


                
    <span class="article-tags">
    <i class="iconfont icon-tag"></i>
    <a class="article-tag-none-link" href="/tags/C/" rel="tag">C</a>, <a class="article-tag-none-link" href="/tags/asm/" rel="tag">asm</a>, <a class="article-tag-none-link" href="/tags/coroutine/" rel="tag">coroutine</a>
  </span>


                <span class="_partial/post-comment"><i class="icon icon-comment"></i>
                    <a href="/2020/01/02/libco/#comments" class="article-comment-link">
                        评论
                    </a>
                </span>
                
    
        <span class="post-wordcount" itemprop="wordCount">字数统计: 3.8k(字)</span>
    
    
        <span class="post-readcount" itemprop="timeRequired">阅读时长: 18(分)</span>
    


            </p>
        </header>
        <div class="marked-body article-body">
            <h2 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h2><ol>
<li>使用示例，函数说明</li>
<li>协程切换如何实现</li>
<li>支持哪些异步事件</li>
</ol>
<h2 id="一-协程相关接口"><a href="#一-协程相关接口" class="headerlink" title="一 协程相关接口"></a>一 协程相关接口</h2><h3 id="1-相关数据结构"><a href="#1-相关数据结构" class="headerlink" title="1. 相关数据结构"></a>1. 相关数据结构</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 协程结构体</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">stCoRoutine_t</span></span><br><span class="line">&#123;</span><br><span class="line">    stCoRoutineEnv_t *env;</span><br><span class="line">    <span class="type">pfn_co_routine_t</span> pfn;   <span class="comment">// 协程入口函数</span></span><br><span class="line">    <span class="type">void</span> *arg;              <span class="comment">// 协程参数</span></span><br><span class="line">    <span class="type">coctx_t</span> ctx;            <span class="comment">// 协程上下文，在协程切换时保存寄存器值</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 协程状态标记</span></span><br><span class="line">    <span class="type">char</span> cStart;</span><br><span class="line">    <span class="type">char</span> cEnd;</span><br><span class="line">    <span class="type">char</span> cIsMain;</span><br><span class="line">    <span class="type">char</span> cEnableSysHook;</span><br><span class="line">    <span class="type">char</span> cIsShareStack;</span><br><span class="line"></span><br><span class="line">    <span class="type">void</span> *pvEnv;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//char sRunStack[ 1024 * 128 ];</span></span><br><span class="line">    stStackMem_t* stack_mem;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// save stack buffer while conflict on same stack_buffer;</span></span><br><span class="line">    <span class="type">char</span>* stack_sp;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> save_size;</span><br><span class="line">    <span class="type">char</span>* save_buffer;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 协程局部变量</span></span><br><span class="line">    stCoSpec_t aSpec[<span class="number">1024</span>];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 协程运行环境，可以理解为虚拟机</span></span><br><span class="line"><span class="comment">// 每个协程必定在一个 stCoRoutineEnv_t 中运行</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">stCoRoutineEnv_t</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 协程调用栈，最多 128 层</span></span><br><span class="line">    <span class="comment">// 这个调用栈的含义是 coroutine-1 创建 coroutine-2... 最大深度</span></span><br><span class="line">    stCoRoutine_t *pCallStack[ <span class="number">128</span> ];</span><br><span class="line">    <span class="type">int</span> iCallStackSize;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 事件循环驱动</span></span><br><span class="line">    stCoEpoll_t *pEpoll;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//for copy stack log lastco and nextco</span></span><br><span class="line">    stCoRoutine_t* pending_co;</span><br><span class="line">    stCoRoutine_t* occupy_co;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">stCoEpoll_t</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> iEpollFd;</span><br><span class="line">    <span class="type">static</span> <span class="type">const</span> <span class="type">int</span> _EPOLL_SIZE = <span class="number">1024</span> * <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">stTimeout_t</span> *pTimeout;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">stTimeoutItemLink_t</span> *pstTimeoutList;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">stTimeoutItemLink_t</span> *pstActiveList;</span><br><span class="line"></span><br><span class="line">    co_epoll_res *result;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="2-执行环境"><a href="#2-执行环境" class="headerlink" title="2. 执行环境"></a>2. 执行环境</h3><p>协程需要运行在“执行环境”或“虚拟机”中，在使用 <code>libco</code> 时可以不要显示创建协程执行环境，每个<strong>线程</strong>都会有个默认执行环境“gCoEnvPerThread”。使用 <code>libco</code> 可以使用多线程多协程模式，每个线程与 CPU 绑定，每个线程有独立的协程执行环境。</p>
<p><strong>创建执行环境时会创建一个主协程，不做任何事情，只用来与其他协程进行切换。协程中的 <code>coctx_t</code> 会保存协程切换时的寄存器状态，当再次切换到协程时会执行 <code>co_swap</code> 之后代码。这样就实现了用同步的视角实现异步逻辑。</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> __thread stCoRoutineEnv_t* gCoEnvPerThread = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">co_init_curr_thread_env</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    gCoEnvPerThread = (stCoRoutineEnv_t*)<span class="built_in">calloc</span>( <span class="number">1</span>, <span class="built_in">sizeof</span>(stCoRoutineEnv_t) );</span><br><span class="line">    stCoRoutineEnv_t *env = gCoEnvPerThread;</span><br><span class="line"></span><br><span class="line">    env-&gt;iCallStackSize = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// 创建主协程</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">stCoRoutine_t</span> *self = <span class="built_in">co_create_env</span>( env, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span> );</span><br><span class="line">    self-&gt;cIsMain = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    env-&gt;pending_co = <span class="literal">NULL</span>;</span><br><span class="line">    env-&gt;occupy_co = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">coctx_init</span>( &amp;self-&gt;ctx );</span><br><span class="line"></span><br><span class="line">    env-&gt;pCallStack[ env-&gt;iCallStackSize++ ] = self;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// epoll fd</span></span><br><span class="line">    stCoEpoll_t *ev = <span class="built_in">AllocEpoll</span>();</span><br><span class="line">    <span class="built_in">SetEpoll</span>( env,ev );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-创建协程"><a href="#3-创建协程" class="headerlink" title="3. 创建协程"></a>3. 创建协程</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*******************************************************************************</span></span><br><span class="line"><span class="comment"> * @param   co      stCoRoutine_t**     创建的协程对象，出参</span></span><br><span class="line"><span class="comment"> * @param   attr    stCoRoutineAttr_t   协程属性，入参，定义栈大小、共享栈属性</span></span><br><span class="line"><span class="comment"> * @param   routine void*(*func)(void*) 协程执行函数</span></span><br><span class="line"><span class="comment"> * @param   arg     void*               协程执行参数</span></span><br><span class="line"><span class="comment"> * @return  返回值无意义</span></span><br><span class="line"><span class="comment"> ******************************************************************************/</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">co_create</span><span class="params">( stCoRoutine_t **ppco,<span class="type">const</span> stCoRoutineAttr_t *attr,<span class="type">pfn_co_routine_t</span> pfn,<span class="type">void</span> *arg )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>( !<span class="built_in">co_get_curr_thread_env</span>() )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">co_init_curr_thread_env</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    stCoRoutine_t *co = <span class="built_in">co_create_env</span>( <span class="built_in">co_get_curr_thread_env</span>(), attr, pfn,arg );</span><br><span class="line">    *ppco = co;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*******************************************************************************</span></span><br><span class="line"><span class="comment"> * 与 co_create 类似，附加参数 env 指定了创建协程的执行环境</span></span><br><span class="line"><span class="comment"> * @param   env     stCoRoutineEnv_t*   协程执行环境</span></span><br><span class="line"><span class="comment"> * @param   co      stCoRoutine_t**     创建的协程对象，出差</span></span><br><span class="line"><span class="comment"> * @param   attr    stCoRoutineAttr_t   协程属性，入参，定义栈大小、共享栈属性</span></span><br><span class="line"><span class="comment"> * @param   routine void*(*func)(void*) 协程执行函数</span></span><br><span class="line"><span class="comment"> * @param   arg     void*               协程执行参数</span></span><br><span class="line"><span class="comment"> * @return  返回值无意义</span></span><br><span class="line"><span class="comment"> ******************************************************************************/</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">stCoRoutine_t</span> *<span class="built_in">co_create_env</span>( stCoRoutineEnv_t *env, <span class="type">const</span> stCoRoutineAttr_t* attr, <span class="type">pfn_co_routine_t</span> pfn, <span class="type">void</span> *arg )</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    stCoRoutineAttr_t at;</span><br><span class="line">    <span class="keyword">if</span>( attr )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">memcpy</span>( &amp;at,attr,<span class="built_in">sizeof</span>(at) );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>( at.stack_size &lt;= <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        at.stack_size = <span class="number">128</span> * <span class="number">1024</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>( at.stack_size &gt; <span class="number">1024</span> * <span class="number">1024</span> * <span class="number">8</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        at.stack_size = <span class="number">1024</span> * <span class="number">1024</span> * <span class="number">8</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>( at.stack_size &amp; <span class="number">0xFFF</span> ) </span><br><span class="line">    &#123;</span><br><span class="line">        at.stack_size &amp;= ~<span class="number">0xFFF</span>;</span><br><span class="line">        at.stack_size += <span class="number">0x1000</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    stCoRoutine_t *lp = (stCoRoutine_t*)<span class="built_in">malloc</span>( <span class="built_in">sizeof</span>(stCoRoutine_t) );</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>( lp,<span class="number">0</span>,(<span class="type">long</span>)(<span class="built_in">sizeof</span>(stCoRoutine_t)));</span><br><span class="line"></span><br><span class="line">    lp-&gt;env = env; <span class="comment">// 协程执行虚拟机</span></span><br><span class="line">    lp-&gt;pfn = pfn; <span class="comment">// 执行函数</span></span><br><span class="line">    lp-&gt;arg = arg; <span class="comment">// 执行参数</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 栈内存分配，使用共享栈内存或独立栈内存</span></span><br><span class="line">    <span class="comment">// 如果使用共享栈内存会与多个协程共享栈内存空间</span></span><br><span class="line">    stStackMem_t* stack_mem = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span>( at.share_stack )</span><br><span class="line">    &#123;</span><br><span class="line">        stack_mem = <span class="built_in">co_get_stackmem</span>( at.share_stack);</span><br><span class="line">        at.stack_size = at.share_stack-&gt;stack_size;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        stack_mem = <span class="built_in">co_alloc_stackmem</span>(at.stack_size);</span><br><span class="line">    &#125;</span><br><span class="line">    lp-&gt;stack_mem = stack_mem;</span><br><span class="line"></span><br><span class="line">    lp-&gt;ctx.ss_sp = stack_mem-&gt;stack_buffer;</span><br><span class="line">    lp-&gt;ctx.ss_size = at.stack_size;</span><br><span class="line"></span><br><span class="line">    lp-&gt;cStart = <span class="number">0</span>;</span><br><span class="line">    lp-&gt;cEnd = <span class="number">0</span>;</span><br><span class="line">    lp-&gt;cIsMain = <span class="number">0</span>;</span><br><span class="line">    lp-&gt;cEnableSysHook = <span class="number">0</span>;</span><br><span class="line">    lp-&gt;cIsShareStack = at.share_stack != <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    lp-&gt;save_size = <span class="number">0</span>;</span><br><span class="line">    lp-&gt;save_buffer = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> lp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-启动协程"><a href="#4-启动协程" class="headerlink" title="4. 启动协程"></a>4. 启动协程</h3><p>使用 <code>co_resume</code> 可以启动协程，在 <code>co_resume</code> 会先创建协程执行上下文。当事件触发时，会再次切换到当前协程，此时调用 <code>CoRoutineFunc</code> 函数。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*******************************************************************************</span></span><br><span class="line"><span class="comment"> * 当前执行协程让出，切换到 co 协程进行运行</span></span><br><span class="line"><span class="comment"> * @param   co      stCoRoutine_t       待运行协程</span></span><br><span class="line"><span class="comment"> ******************************************************************************/</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">co_resume</span><span class="params">( stCoRoutine_t *co )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    stCoRoutineEnv_t *env = co-&gt;env;</span><br><span class="line">    <span class="comment">// lpCurrRoutine 是正在执行协程</span></span><br><span class="line">    stCoRoutine_t *lpCurrRoutine = env-&gt;pCallStack[ env-&gt;iCallStackSize - <span class="number">1</span> ];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 协程未启动</span></span><br><span class="line">    <span class="keyword">if</span>( !co-&gt;cStart )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 创建协程调用上下文，使用 CoRoutineFunc 函数地址作为执行栈，协程 co，0 作为 CoRoutineFunc 函数的参数。</span></span><br><span class="line">        <span class="comment">// CoRoutineFunc 函数作为所有协程的 wrapper 函数。</span></span><br><span class="line">        <span class="comment">// coctx_make 需要对 32 位、64 位做兼容，两种的函数调用方式是不同的。</span></span><br><span class="line">        <span class="built_in">coctx_make</span>( &amp;co-&gt;ctx,(<span class="type">coctx_pfn_t</span>)CoRoutineFunc, co, <span class="number">0</span> );</span><br><span class="line">        co-&gt;cStart = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将当前协程放在执行虚拟机栈上，当前协程是执行协程</span></span><br><span class="line">    env-&gt;pCallStack[ env-&gt;iCallStackSize++ ] = co;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 协程切换，执行当前协程 co</span></span><br><span class="line">    <span class="built_in">co_swap</span>( lpCurrRoutine, co );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(__i386__)</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">coctx_make</span><span class="params">(<span class="type">coctx_t</span>* ctx, <span class="type">coctx_pfn_t</span> pfn, <span class="type">const</span> <span class="type">void</span>* s, <span class="type">const</span> <span class="type">void</span>* s1)</span> </span>&#123;</span><br><span class="line">    <span class="type">char</span>* sp = ctx-&gt;ss_sp + ctx-&gt;ss_size - <span class="built_in">sizeof</span>(<span class="type">coctx_param_t</span>);</span><br><span class="line">    sp = (<span class="type">char</span>*)((<span class="type">unsigned</span> <span class="type">long</span>)sp &amp; <span class="number">-16L</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">coctx_param_t</span>* param = (<span class="type">coctx_param_t</span>*)sp;</span><br><span class="line">    <span class="type">void</span>** ret_addr = (<span class="type">void</span>**)(sp - <span class="built_in">sizeof</span>(<span class="type">void</span>*) * <span class="number">2</span>);</span><br><span class="line">    *ret_addr = (<span class="type">void</span>*)pfn;</span><br><span class="line">    <span class="comment">// 参数在栈上</span></span><br><span class="line">    param-&gt;s1 = s;</span><br><span class="line">    param-&gt;s2 = s1;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">memset</span>(ctx-&gt;regs, <span class="number">0</span>, <span class="built_in">sizeof</span>(ctx-&gt;regs));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在 32 位模式下，使用栈传递参数。pfn 函数有两个参数，栈顶需要移动两个指针长度。</span></span><br><span class="line">    ctx-&gt;regs[kESP] = (<span class="type">char</span>*)(sp) - <span class="built_in">sizeof</span>(<span class="type">void</span>*) * <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> defined(__x86_64__)</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">coctx_make</span><span class="params">(<span class="type">coctx_t</span>* ctx, <span class="type">coctx_pfn_t</span> pfn, <span class="type">const</span> <span class="type">void</span>* s, <span class="type">const</span> <span class="type">void</span>* s1)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 栈顶, 64 位使用寄存器传递参数，寄存器不够时才会使用栈。</span></span><br><span class="line">    <span class="comment">// pfn 函数只有两个参数，直接使用寄存器，不会在栈上存储参数。</span></span><br><span class="line">    <span class="type">char</span>* sp = ctx-&gt;ss_sp + ctx-&gt;ss_size - <span class="built_in">sizeof</span>(<span class="type">void</span>*);</span><br><span class="line">    sp = (<span class="type">char</span>*)((<span class="type">unsigned</span> <span class="type">long</span>)sp &amp; <span class="number">-16LL</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 寄存器置零</span></span><br><span class="line">    <span class="built_in">memset</span>(ctx-&gt;regs, <span class="number">0</span>, <span class="built_in">sizeof</span>(ctx-&gt;regs));</span><br><span class="line">    <span class="comment">// 函数地址</span></span><br><span class="line">    <span class="type">void</span>** ret_addr = (<span class="type">void</span>**)(sp);</span><br><span class="line">    *ret_addr = (<span class="type">void</span>*)pfn;</span><br><span class="line"></span><br><span class="line">    ctx-&gt;regs[kRSP] = sp;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// kRETAddr 用于存储 IP 寄存器地址。</span></span><br><span class="line">    <span class="comment">// 在 coctx_swap 调用中会将 regs[kRETAddr] 入栈，在 coctx_swap 的最后有 ret 指令，触发 pop ip，跳转到 pfn 处执行。</span></span><br><span class="line">    ctx-&gt;regs[kRETAddr] = (<span class="type">char</span>*)pfn;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  pfn 函数的第一个参数</span></span><br><span class="line">    ctx-&gt;regs[kRDI] = (<span class="type">char</span>*)s;</span><br><span class="line">    <span class="comment">// pfn 函数的第二个参数</span></span><br><span class="line">    ctx-&gt;regs[kRSI] = (<span class="type">char</span>*)s1;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">int</span> <span class="title">CoRoutineFunc</span><span class="params">( stCoRoutine_t *co,<span class="type">void</span> * )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>( co-&gt;pfn )</span><br><span class="line">    &#123;</span><br><span class="line">        co-&gt;<span class="built_in">pfn</span>( co-&gt;arg );</span><br><span class="line">    &#125;</span><br><span class="line">    co-&gt;cEnd = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    stCoRoutineEnv_t *env = co-&gt;env;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">co_yield_env</span>( env );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>函数 <code>co_swap</code> 是协程切换核心，使用汇编实现：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">.globl coctx_swap</span><br><span class="line">#if !defined( __APPLE__ )</span><br><span class="line">.type  coctx_swap, @function</span><br><span class="line">#endif</span><br><span class="line">coctx_swap:</span><br><span class="line"></span><br><span class="line">#if defined(__i386__)</span><br><span class="line">    # 4(%esp) 是调用 coctx_swap 函数的第一个参数</span><br><span class="line">    movl 4(%esp), %eax</span><br><span class="line">    # sp 是 ip 值，ret 指令使用</span><br><span class="line">    movl %esp,  28(%eax)</span><br><span class="line">    movl %ebp, 24(%eax)</span><br><span class="line">    movl %esi, 20(%eax)</span><br><span class="line">    movl %edi, 16(%eax)</span><br><span class="line">    movl %edx, 12(%eax)</span><br><span class="line">    movl %ecx, 8(%eax)</span><br><span class="line">    movl %ebx, 4(%eax)</span><br><span class="line"></span><br><span class="line">    # 8(%esp) 是调用 coctx_swap 函数的第二个参数</span><br><span class="line">    movl 8(%esp), %eax</span><br><span class="line">    movl 4(%eax), %ebx</span><br><span class="line">    movl 8(%eax), %ecx</span><br><span class="line">    movl 12(%eax), %edx</span><br><span class="line">    movl 16(%eax), %edi</span><br><span class="line">    movl 20(%eax), %esi</span><br><span class="line">    movl 24(%eax), %ebp</span><br><span class="line">    # 设置栈顶值，当 ret 指令调用时会触发 pop ip，恢复原先的执行</span><br><span class="line">    movl 28(%eax), %esp</span><br><span class="line"></span><br><span class="line">    ret</span><br><span class="line"></span><br><span class="line">#elif defined(__x86_64__)</span><br><span class="line">    # 函数调用传参，优先将参数传递给寄存器，当寄存器不够用时，会丛右到左压栈，然后再传参给寄存器。</span><br><span class="line">    # %rdi，%rsi，%rdx，%rcx，%r8，%r9, 这6个不够用的时候才会借用栈。</span><br><span class="line">    # 所以 %rdi 是第一个参数，是保存寄存器组内存的首地址。</span><br><span class="line"></span><br><span class="line">    leaq (%rsp), %rax</span><br><span class="line">    movq %rax, 104(%rdi)</span><br><span class="line">    movq %rbx, 96(%rdi)</span><br><span class="line">    movq %rcx, 88(%rdi)</span><br><span class="line">    movq %rdx, 80(%rdi)</span><br><span class="line">    movq 0(%rax), %rax</span><br><span class="line">    movq %rax, 72(%rdi) </span><br><span class="line">    movq %rsi, 64(%rdi)</span><br><span class="line">    movq %rdi, 56(%rdi)</span><br><span class="line">    movq %rbp, 48(%rdi)</span><br><span class="line">    movq %r8, 40(%rdi)</span><br><span class="line">    movq %r9, 32(%rdi)</span><br><span class="line">    movq %r12, 24(%rdi)</span><br><span class="line">    movq %r13, 16(%rdi)</span><br><span class="line">    movq %r14, 8(%rdi)</span><br><span class="line">    movq %r15, (%rdi)</span><br><span class="line">    xorq %rax, %rax</span><br><span class="line"></span><br><span class="line">    movq 48(%rsi), %rbp</span><br><span class="line">    movq 104(%rsi), %rsp</span><br><span class="line">    movq (%rsi), %r15</span><br><span class="line">    movq 8(%rsi), %r14</span><br><span class="line">    movq 16(%rsi), %r13</span><br><span class="line">    movq 24(%rsi), %r12</span><br><span class="line">    movq 32(%rsi), %r9</span><br><span class="line">    movq 40(%rsi), %r8</span><br><span class="line">    movq 56(%rsi), %rdi</span><br><span class="line">    movq 80(%rsi), %rdx</span><br><span class="line">    movq 88(%rsi), %rcx</span><br><span class="line">    movq 96(%rsi), %rbx</span><br><span class="line">    leaq 8(%rsp), %rsp</span><br><span class="line">    pushq 72(%rsi) // ip 入栈</span><br><span class="line"></span><br><span class="line">    movq 64(%rsi), %rsi</span><br><span class="line">    ret</span><br><span class="line">#endif</span><br></pre></td></tr></table></figure>

<h3 id="5-让出执行"><a href="#5-让出执行" class="headerlink" title="5. 让出执行"></a>5. 让出执行</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*******************************************************************************</span></span><br><span class="line"><span class="comment"> * 当前协程让出，上层调用栈协程运行</span></span><br><span class="line"><span class="comment"> * @param   co      stCoRoutine_t       待让出协程</span></span><br><span class="line"><span class="comment"> ******************************************************************************/</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">co_yield</span><span class="params">( stCoRoutine_t *co )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">co_yield_env</span>( co-&gt;env );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">co_yield_env</span><span class="params">( stCoRoutineEnv_t *env )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    stCoRoutine_t *last = env-&gt;pCallStack[ env-&gt;iCallStackSize - <span class="number">2</span> ];</span><br><span class="line">    stCoRoutine_t *curr = env-&gt;pCallStack[ env-&gt;iCallStackSize - <span class="number">1</span> ];</span><br><span class="line"></span><br><span class="line">    env-&gt;iCallStackSize--;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">co_swap</span>( curr, last);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="6-设置-获取协程局部变量"><a href="#6-设置-获取协程局部变量" class="headerlink" title="6. 设置/获取协程局部变量"></a>6. 设置/获取协程局部变量</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> *<span class="title">co_getspecific</span><span class="params">(<span class="type">pthread_key_t</span> key)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    stCoRoutine_t *co = <span class="built_in">GetCurrThreadCo</span>();</span><br><span class="line">    <span class="keyword">if</span>( !co || co-&gt;cIsMain )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">pthread_getspecific</span>( key );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> co-&gt;aSpec[ key ].value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">co_setspecific</span><span class="params">(<span class="type">pthread_key_t</span> key, <span class="type">const</span> <span class="type">void</span> *value)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    stCoRoutine_t *co = <span class="built_in">GetCurrThreadCo</span>();</span><br><span class="line">    <span class="keyword">if</span>( !co || co-&gt;cIsMain )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">pthread_setspecific</span>( key,value );</span><br><span class="line">    &#125;</span><br><span class="line">    co-&gt;aSpec[ key ].value = (<span class="type">void</span>*)value;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="7-协程释放"><a href="#7-协程释放" class="headerlink" title="7. 协程释放"></a>7. 协程释放</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*******************************************************************************</span></span><br><span class="line"><span class="comment"> * 释放协程对象 co</span></span><br><span class="line"><span class="comment"> * @param   co      stCoRoutine_t       待释放协程对象</span></span><br><span class="line"><span class="comment"> ******************************************************************************/</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">co_release</span><span class="params">( stCoRoutine_t *co )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">co_free</span>( co );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">co_free</span><span class="params">( stCoRoutine_t *co )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!co-&gt;cIsShareStack)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">free</span>(co-&gt;stack_mem-&gt;stack_buffer);</span><br><span class="line">        <span class="built_in">free</span>(co-&gt;stack_mem);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>(co-&gt;save_buffer)</span><br><span class="line">            <span class="built_in">free</span>(co-&gt;save_buffer);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(co-&gt;stack_mem-&gt;occupy_co == co)</span><br><span class="line">            co-&gt;stack_mem-&gt;occupy_co = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>( co );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*******************************************************************************</span></span><br><span class="line"><span class="comment"> * @param   co      stCoRoutine_t       协程对象</span></span><br><span class="line"><span class="comment"> ******************************************************************************/</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">co_reset</span><span class="params">(stCoRoutine_t * co)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!co-&gt;cStart || co-&gt;cIsMain)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    co-&gt;cStart = <span class="number">0</span>;</span><br><span class="line">    co-&gt;cEnd = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(co-&gt;save_buffer)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">free</span>(co-&gt;save_buffer);</span><br><span class="line">        co-&gt;save_buffer = <span class="literal">NULL</span>;</span><br><span class="line">        co-&gt;save_size = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果共享栈被当前协程占用，要释放占用标志，否则被切换，会执行save_stack_buffer()</span></span><br><span class="line">    <span class="keyword">if</span>(co-&gt;stack_mem-&gt;occupy_co == co)</span><br><span class="line">        co-&gt;stack_mem-&gt;occupy_co = <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="二-事件循环"><a href="#二-事件循环" class="headerlink" title="二 事件循环"></a>二 事件循环</h2><h3 id="1-等待事件触发"><a href="#1-等待事件触发" class="headerlink" title="1. 等待事件触发"></a>1. 等待事件触发</h3><p>函数 <code>co_poll</code> 用来同步或异步等待事件触发。当前协程希望监听某一事件时，向协程执行环境的事件循环实例注册事件监听、超时监听，同时进行协程切换。当事件触发时会切换到当前协程的协程切换点执行。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*******************************************************************************</span></span><br><span class="line"><span class="comment"> * 向 event_fd 添加监控事件，之所以使用 fds 数组是为了与 poll 函数兼容。</span></span><br><span class="line"><span class="comment"> * 虽然参数格式是数组，但是每次调用都添加一个文件描述符，如果使用多个文件描述符会共享同一个超时时间。</span></span><br><span class="line"><span class="comment"> * @param   ctx         stCoEpoll_t       协程对象</span></span><br><span class="line"><span class="comment"> * @param   fds         struct pollfd     待添加文件描述符</span></span><br><span class="line"><span class="comment"> * @param   nfds        nfds_t            待添加事件数量</span></span><br><span class="line"><span class="comment"> * @param   timeout_ms  int               事件超时时间</span></span><br><span class="line"><span class="comment"> ******************************************************************************/</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">co_poll</span><span class="params">( stCoEpoll_t *ctx,<span class="keyword">struct</span> pollfd fds[], <span class="type">nfds_t</span> nfds, <span class="type">int</span> timeout_ms )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">co_poll_inner</span>(ctx, fds, nfds, timeout_ms, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">int</span> <span class="params">(*<span class="type">poll_pfn_t</span>)</span><span class="params">(<span class="keyword">struct</span> pollfd fds[], <span class="type">nfds_t</span> nfds, <span class="type">int</span> timeout)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">co_poll_inner</span><span class="params">( stCoEpoll_t *ctx,<span class="keyword">struct</span> pollfd fds[], <span class="type">nfds_t</span> nfds, <span class="type">int</span> timeout, <span class="type">poll_pfn_t</span> pollfunc)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (timeout == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">pollfunc</span>(fds, nfds, timeout);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (timeout &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        timeout = INT_MAX;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> epfd = ctx-&gt;iEpollFd;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// co_self 获取当前正在执行协程</span></span><br><span class="line">    stCoRoutine_t* self = <span class="built_in">co_self</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1.struct change</span></span><br><span class="line">    stPoll_t&amp; arg = *((stPoll_t*)<span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(stPoll_t)));</span><br><span class="line">    <span class="built_in">memset</span>( &amp;arg, <span class="number">0</span>, <span class="built_in">sizeof</span>(arg) );</span><br><span class="line"></span><br><span class="line">    arg.iEpollFd = epfd;</span><br><span class="line">    arg.fds = (pollfd*)<span class="built_in">calloc</span>(nfds, <span class="built_in">sizeof</span>(pollfd));</span><br><span class="line">    arg.nfds = nfds;</span><br><span class="line"></span><br><span class="line">    stPollItem_t arr[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">if</span>( nfds &lt; <span class="built_in">sizeof</span>(arr) / <span class="built_in">sizeof</span>(arr[<span class="number">0</span>]) &amp;&amp; !self-&gt;cIsShareStack)</span><br><span class="line">    &#123;</span><br><span class="line">        arg.pPollItems = arr;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        arg.pPollItems = (stPollItem_t*)<span class="built_in">malloc</span>( nfds * <span class="built_in">sizeof</span>( stPollItem_t ) );</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memset</span>( arg.pPollItems, <span class="number">0</span>, nfds * <span class="built_in">sizeof</span>(stPollItem_t) );</span><br><span class="line"></span><br><span class="line">    arg.pfnProcess = OnPollProcessEvent;</span><br><span class="line">    arg.pArg = <span class="built_in">GetCurrCo</span>( <span class="built_in">co_get_curr_thread_env</span>() );</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 增加监听事件</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">nfds_t</span> i=<span class="number">0</span>;i&lt;nfds;i++)</span><br><span class="line">    &#123;</span><br><span class="line">        arg.pPollItems[i].pSelf = arg.fds + i;</span><br><span class="line">        arg.pPollItems[i].pPoll = &amp;arg;</span><br><span class="line"></span><br><span class="line">        arg.pPollItems[i].pfnPrepare = OnPollPreparePfn;</span><br><span class="line">        <span class="keyword">struct</span> <span class="title class_">epoll_event</span> &amp;ev = arg.pPollItems[i].stEvent;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>( fds[i].fd &gt; <span class="number">-1</span> )</span><br><span class="line">        &#123;</span><br><span class="line">            ev.data.ptr = arg.pPollItems + i;</span><br><span class="line">            ev.events = <span class="built_in">PollEvent2Epoll</span>( fds[i].events );</span><br><span class="line"></span><br><span class="line">            <span class="type">int</span> ret = <span class="built_in">co_epoll_ctl</span>( epfd,EPOLL_CTL_ADD, fds[i].fd, &amp;ev );</span><br><span class="line">            <span class="keyword">if</span> (ret &lt; <span class="number">0</span> &amp;&amp; errno == EPERM &amp;&amp; nfds == <span class="number">1</span> &amp;&amp; pollfunc != <span class="literal">NULL</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span>( arg.pPollItems != arr )</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="built_in">free</span>( arg.pPollItems );</span><br><span class="line">                    arg.pPollItems = <span class="literal">NULL</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="built_in">free</span>(arg.fds);</span><br><span class="line">                <span class="built_in">free</span>(&amp;arg);</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">pollfunc</span>(fds, nfds, timeout);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3. 增加超时事件</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> now = <span class="built_in">GetTickMS</span>();</span><br><span class="line">    arg.ullExpireTime = now + timeout;</span><br><span class="line">    <span class="type">int</span> ret = <span class="built_in">AddTimeout</span>( ctx-&gt;pTimeout, &amp;arg,now );</span><br><span class="line">    <span class="type">int</span> iRaiseCnt = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>( ret != <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">co_log_err</span>(<span class="string">&quot;CO_ERR: AddTimeout ret %d now %lld timeout %d arg.ullExpireTime %lld&quot;</span>,</span><br><span class="line">                ret,now,timeout,arg.ullExpireTime);</span><br><span class="line">        errno = EINVAL;</span><br><span class="line">        iRaiseCnt = <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 协程切换</span></span><br><span class="line">        <span class="built_in">co_yield_env</span>( <span class="built_in">co_get_curr_thread_env</span>() );</span><br><span class="line">        iRaiseCnt = arg.iRaiseCnt;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 移除超时事件</span></span><br><span class="line">        <span class="built_in">RemoveFromLink</span>&lt;stTimeoutItem_t,stTimeoutItemLink_t&gt;( &amp;arg );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 移除监听事件</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">nfds_t</span> i = <span class="number">0</span>;i &lt; nfds;i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="type">int</span> fd = fds[i].fd;</span><br><span class="line">            <span class="keyword">if</span>( fd &gt; <span class="number">-1</span> )</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">co_epoll_ctl</span>( epfd,EPOLL_CTL_DEL,fd,&amp;arg.pPollItems[i].stEvent );</span><br><span class="line">            &#125;</span><br><span class="line">            fds[i].revents = arg.fds[i].revents;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>( arg.pPollItems != arr )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">free</span>( arg.pPollItems );</span><br><span class="line">            arg.pPollItems = <span class="literal">NULL</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">free</span>(arg.fds);</span><br><span class="line">        <span class="built_in">free</span>(&amp;arg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> iRaiseCnt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">OnPollProcessEvent</span><span class="params">( stTimeoutItem_t * ap )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    stCoRoutine_t *co = (stCoRoutine_t*)ap-&gt;pArg;</span><br><span class="line">    <span class="built_in">co_resume</span>( co );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">OnPollPreparePfn</span><span class="params">( stTimeoutItem_t * ap,<span class="keyword">struct</span> epoll_event &amp;e,stTimeoutItemLink_t *active )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    stPollItem_t *lp = (stPollItem_t *)ap;</span><br><span class="line">    <span class="comment">// 触发的事件</span></span><br><span class="line">    lp-&gt;pSelf-&gt;revents = <span class="built_in">EpollEvent2Poll</span>( e.events );</span><br><span class="line"></span><br><span class="line">    stPoll_t *pPoll = lp-&gt;pPoll;</span><br><span class="line">    pPoll-&gt;iRaiseCnt++;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 有一个事件触发后就会加入活跃事件队列，iAllEventDetach 成员用于避免加入多次</span></span><br><span class="line">    <span class="comment">// 此处业务使用 co_poll 时应该添加对一个事件的监听，而非增加多个事件原因，导致了代码逻辑混乱</span></span><br><span class="line">    <span class="keyword">if</span>( !pPoll-&gt;iAllEventDetach )</span><br><span class="line">    &#123;</span><br><span class="line">        pPoll-&gt;iAllEventDetach = <span class="number">1</span>;</span><br><span class="line">        <span class="built_in">RemoveFromLink</span>&lt;stTimeoutItem_t,stTimeoutItemLink_t&gt;( pPoll );</span><br><span class="line">        <span class="built_in">AddTail</span>( active,pPoll );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-主协程事件循环"><a href="#2-主协程事件循环" class="headerlink" title="2. 主协程事件循环"></a>2. 主协程事件循环</h3><p><strong>主协程</strong>事件循环处理用于协程调度，其核心是使用 <code>epoll_wait</code> 等待事件（异步事件、超时事件）触发，执行事件。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*******************************************************************************</span></span><br><span class="line"><span class="comment"> * 主协程事件处理循环</span></span><br><span class="line"><span class="comment"> * @param   ctx         stCoEpoll_t         协程对象</span></span><br><span class="line"><span class="comment"> * @param   pfn         pfn_co_eventloop_t  退出检查函数</span></span><br><span class="line"><span class="comment"> * @param   arg         void*               退出检查函数参数</span></span><br><span class="line"><span class="comment"> ******************************************************************************/</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">co_eventloop</span><span class="params">( stCoEpoll_t *ctx, <span class="type">pfn_co_eventloop_t</span> pfn, <span class="type">void</span> *arg )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>( !ctx-&gt;result )</span><br><span class="line">    &#123;</span><br><span class="line">        ctx-&gt;result =  <span class="built_in">co_epoll_res_alloc</span>( stCoEpoll_t::_EPOLL_SIZE );</span><br><span class="line">    &#125;</span><br><span class="line">    co_epoll_res *result = ctx-&gt;result;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(;;)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> ret = <span class="built_in">co_epoll_wait</span>( ctx-&gt;iEpollFd, result,stCoEpoll_t::_EPOLL_SIZE, <span class="number">1</span> );</span><br><span class="line"></span><br><span class="line">        stTimeoutItemLink_t *active = (ctx-&gt;pstActiveList);</span><br><span class="line">        stTimeoutItemLink_t *timeout = (ctx-&gt;pstTimeoutList);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">memset</span>( timeout,<span class="number">0</span>,<span class="built_in">sizeof</span>(stTimeoutItemLink_t) );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 触发事件队列</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;ret; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            stTimeoutItem_t *item = (stTimeoutItem_t*)result-&gt;events[i].data.ptr;</span><br><span class="line">            <span class="keyword">if</span>( item-&gt;pfnPrepare )</span><br><span class="line">            &#123;</span><br><span class="line">                item-&gt;<span class="built_in">pfnPrepare</span>( item, result-&gt;events[i], active );</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">AddTail</span>( active, item );</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 超时事件队列</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> now = <span class="built_in">GetTickMS</span>();</span><br><span class="line">        <span class="built_in">TakeAllTimeout</span>( ctx-&gt;pTimeout, now, timeout );</span><br><span class="line"></span><br><span class="line">        stTimeoutItem_t *lp = timeout-&gt;head;</span><br><span class="line">        <span class="keyword">while</span>( lp )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//printf(&quot;raise timeout %p\n&quot;,lp);</span></span><br><span class="line">            lp-&gt;bTimeout = <span class="literal">true</span>;</span><br><span class="line">            lp = lp-&gt;pNext;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将超时事件队列添加到触发事件队列之后</span></span><br><span class="line">        <span class="built_in">Join</span>&lt;stTimeoutItem_t,stTimeoutItemLink_t&gt;( active,timeout );</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 处理所有事件</span></span><br><span class="line">        lp = active-&gt;head;</span><br><span class="line">        <span class="keyword">while</span>( lp )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 从队列移除事件</span></span><br><span class="line">            <span class="built_in">PopHead</span>&lt;stTimeoutItem_t,stTimeoutItemLink_t&gt;( active );</span><br><span class="line">            <span class="keyword">if</span> (lp-&gt;bTimeout &amp;&amp; now &lt; lp-&gt;ullExpireTime)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="type">int</span> ret = <span class="built_in">AddTimeout</span>(ctx-&gt;pTimeout, lp, now);</span><br><span class="line">                <span class="keyword">if</span> (!ret)</span><br><span class="line">                &#123;</span><br><span class="line">                    lp-&gt;bTimeout = <span class="literal">false</span>;</span><br><span class="line">                    lp = active-&gt;head;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 执行事件处理函数</span></span><br><span class="line">            <span class="keyword">if</span>( lp-&gt;pfnProcess )</span><br><span class="line">            &#123;</span><br><span class="line">                lp-&gt;<span class="built_in">pfnProcess</span>( lp );</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            lp = active-&gt;head;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 事件循环退出检查函数</span></span><br><span class="line">        <span class="keyword">if</span>( pfn )</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>( <span class="number">-1</span> == <span class="built_in">pfn</span>( arg ) )</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-系统调用-hook"><a href="#3-系统调用-hook" class="headerlink" title="3. 系统调用 hook"></a>3. 系统调用 hook</h3><p><code>co_enable_hook_sys</code> 函数用于在阻塞的系统调用时进行协程切换。当开启时，在 <code>read</code>、<code>send</code> 等系统调用点会调用 <code>co_poll</code> 触发协程切换。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*******************************************************************************</span></span><br><span class="line"><span class="comment"> * 开启、关闭系统函数 hook</span></span><br><span class="line"><span class="comment"> * 当开启系统函数 hook 时会调用 poll 函数触发协程切换。当事件触发时，协程切换回来，继续执行。</span></span><br><span class="line"><span class="comment"> ******************************************************************************/</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">co_enable_hook_sys</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">co_disable_hook_sys</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">co_is_enable_sys_hook</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>

<p>在 <code>co_hook_sys_call.cpp</code> 中实现了系统 hook 功能，<code>libco</code> 中定义了 <code>read</code>、<code>send</code> 等函数。以 <code>read</code> 为例说明：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">ssize_t</span> <span class="title">read</span><span class="params">( <span class="type">int</span> fd, <span class="type">void</span> *buf, <span class="type">size_t</span> nbyte )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">HOOK_SYS_FUNC</span>( read );</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span>( !<span class="built_in">co_is_enable_sys_hook</span>() )</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">g_sys_read_func</span>( fd,buf,nbyte );</span><br><span class="line">	&#125;</span><br><span class="line">  ... <span class="comment">// 忽略无关代码</span></span><br><span class="line">	<span class="type">int</span> pollret = <span class="built_in">poll</span>( &amp;pf,<span class="number">1</span>,timeout );</span><br><span class="line">	<span class="type">ssize_t</span> readret = <span class="built_in">g_sys_read_func</span>( fd,(<span class="type">char</span>*)buf ,nbyte );</span><br><span class="line">	<span class="keyword">if</span>( readret &lt; <span class="number">0</span> )</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">co_log_err</span>(<span class="string">&quot;CO_ERR: read fd %d ret %ld errno %d poll ret %d timeout %d&quot;</span>,</span><br><span class="line">					fd,readret,errno,pollret,timeout);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> readret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>HOOK_SYS_FUNC</code> 是宏定义，用生成 <code>g_sys_xxx_func</code> 变量，其值指向系统调用的地址。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> HOOK_SYS_FUNC(name) <span class="keyword">if</span>( !g_sys_##name##_func ) &#123; g_sys_##name##_func = (name##_pfn_t)dlsym(RTLD_NEXT,#name); &#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="4-libco-协程使用"><a href="#4-libco-协程使用" class="headerlink" title="4. libco 协程使用"></a>4. libco 协程使用</h3><p>读 <code>co_poll</code>、<code>co_eventloop</code> 代码会思考该怎样使用 <code>libco</code> 进行事件处理。如果没有协程，异步事件处理应该是：一进程或线程添加事件监听，二进行 <code>epoll_wait</code> 等待事件触发，三处理事件。以 CS 模式为例，在 <code>libco</code> 中应该对 <code>listenfd</code> 创建一个协程、每个 <code>accept</code> 的连接创建一个协程，并将其添加到主协程事件循环中。</p>
<h2 id="三-协程同步"><a href="#三-协程同步" class="headerlink" title="三 协程同步"></a>三 协程同步</h2><p><code>libco</code> 提供了条件变量原语，因为在 <code>libco</code> 中是主动调度，非抢占式调度，因此不必担心竞争状态，实现起来也比较简单。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*OnPreparePfn_t)</span><span class="params">( stTimeoutItem_t *,<span class="keyword">struct</span> epoll_event &amp;ev, stTimeoutItemLink_t *active )</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*OnProcessPfn_t)</span><span class="params">( stTimeoutItem_t *)</span></span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">stTimeoutItem_t</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">enum</span></span><br><span class="line">    &#123;</span><br><span class="line">        eMaxTimeout = <span class="number">40</span> * <span class="number">1000</span> <span class="comment">//40s</span></span><br><span class="line">    &#125;;</span><br><span class="line">    stTimeoutItem_t *pPrev;</span><br><span class="line">    stTimeoutItem_t *pNext;</span><br><span class="line">    stTimeoutItemLink_t *pLink;</span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> ullExpireTime;</span><br><span class="line"></span><br><span class="line">    OnPreparePfn_t pfnPrepare;</span><br><span class="line">    OnProcessPfn_t pfnProcess;</span><br><span class="line"></span><br><span class="line">    <span class="type">void</span> *pArg; <span class="comment">// routine </span></span><br><span class="line">    <span class="type">bool</span> bTimeout;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">stCoCondItem_t</span> </span><br><span class="line">&#123;</span><br><span class="line">    stCoCondItem_t *pPrev;</span><br><span class="line">    stCoCondItem_t *pNext;</span><br><span class="line">    stCoCond_t *pLink;</span><br><span class="line"></span><br><span class="line">    stTimeoutItem_t timeout;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">stCoCond_t</span></span><br><span class="line">&#123;</span><br><span class="line">    stCoCondItem_t *head;</span><br><span class="line">    stCoCondItem_t *tail;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function">stCoCond_t *<span class="title">co_cond_alloc</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">co_cond_free</span><span class="params">( stCoCond_t * cc )</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*******************************************************************************</span></span><br><span class="line"><span class="comment"> * 协程条件变量，用于协程之间的同步</span></span><br><span class="line"><span class="comment"> ******************************************************************************/</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">co_cond_signal</span><span class="params">( stCoCond_t * )</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">co_cond_broadcast</span><span class="params">( stCoCond_t * )</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">co_cond_timedwait</span><span class="params">( stCoCond_t *,<span class="type">int</span> timeout_ms )</span></span>;</span><br></pre></td></tr></table></figure>

<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/Tencent/libco">libco</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/hnes/libaco">libaco</a></li>
<li><a target="_blank" rel="noopener" href="http://purecpp.org/purecpp/static/64a819e99584452aab70a7f9c307717f.pdf">libco 分享</a></li>
<li><a target="_blank" rel="noopener" href="https://www.felixcloutier.com/x86/index.html">指令参考</a></li>
<li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/X86_calling_conventions">函数调用约定</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/u010039418/article/details/85275211">x86 传参规则</a></li>
</ul>

        </div>
        

    </article>
    
    <section id="comments">
        
    </section>


    

</main>


<aside style="" id="sidebar" class="aside aside-fixture">
    <div class="toc-sidebar">
        <nav id="toc" class="article-toc">
            <h3 class="toc-title">文章目录</h3>
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%AE%E7%9A%84"><span class="toc-number">1.</span> <span class="toc-text">目的</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80-%E5%8D%8F%E7%A8%8B%E7%9B%B8%E5%85%B3%E6%8E%A5%E5%8F%A3"><span class="toc-number">2.</span> <span class="toc-text">一 协程相关接口</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E7%9B%B8%E5%85%B3%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-number">2.1.</span> <span class="toc-text">1. 相关数据结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E6%89%A7%E8%A1%8C%E7%8E%AF%E5%A2%83"><span class="toc-number">2.2.</span> <span class="toc-text">2. 执行环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%88%9B%E5%BB%BA%E5%8D%8F%E7%A8%8B"><span class="toc-number">2.3.</span> <span class="toc-text">3. 创建协程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E5%90%AF%E5%8A%A8%E5%8D%8F%E7%A8%8B"><span class="toc-number">2.4.</span> <span class="toc-text">4. 启动协程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E8%AE%A9%E5%87%BA%E6%89%A7%E8%A1%8C"><span class="toc-number">2.5.</span> <span class="toc-text">5. 让出执行</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-%E8%AE%BE%E7%BD%AE-%E8%8E%B7%E5%8F%96%E5%8D%8F%E7%A8%8B%E5%B1%80%E9%83%A8%E5%8F%98%E9%87%8F"><span class="toc-number">2.6.</span> <span class="toc-text">6. 设置&#x2F;获取协程局部变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-%E5%8D%8F%E7%A8%8B%E9%87%8A%E6%94%BE"><span class="toc-number">2.7.</span> <span class="toc-text">7. 协程释放</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C-%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF"><span class="toc-number">3.</span> <span class="toc-text">二 事件循环</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E7%AD%89%E5%BE%85%E4%BA%8B%E4%BB%B6%E8%A7%A6%E5%8F%91"><span class="toc-number">3.1.</span> <span class="toc-text">1. 等待事件触发</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E4%B8%BB%E5%8D%8F%E7%A8%8B%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF"><span class="toc-number">3.2.</span> <span class="toc-text">2. 主协程事件循环</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8-hook"><span class="toc-number">3.3.</span> <span class="toc-text">3. 系统调用 hook</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-libco-%E5%8D%8F%E7%A8%8B%E4%BD%BF%E7%94%A8"><span class="toc-number">3.4.</span> <span class="toc-text">4. libco 协程使用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89-%E5%8D%8F%E7%A8%8B%E5%90%8C%E6%AD%A5"><span class="toc-number">4.</span> <span class="toc-text">三 协程同步</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="toc-number">5.</span> <span class="toc-text">参考资料</span></a></li></ol>
        </nav>
    </div>
</aside>





        </section>
        <footer class="hidden lg:block fixed bottom-0 left-0 sm:w-1/12 lg:w-1/6 bg-gray-100 z-40">
    
    <div class="footer-social-links">
        
            <a target="_blank" rel="noopener" href="https://github.com/juzipeek">
                <i class="iconfont icon-github"></i>
            </a>
        
    </div>
    
    
</footer>

        <div id="mask" class="hidden mask fixed inset-0 bg-gray-900 opacity-75 z-40"></div>
        <div id="search-view-container" class="hidden shadow-xl"></div>
        
<script src="/js/dom-event.min.js"></script>



<script src="/js/local-search.min.js"></script>



    <script src="//cdn.jsdelivr.net/npm/lightgallery.js@1.1.3/dist/js/lightgallery.min.js"></script>
    
<script src="/js/light-gallery.min.js"></script>






    </body>
</html>
