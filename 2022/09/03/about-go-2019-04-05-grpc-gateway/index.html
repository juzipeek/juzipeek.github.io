<!DOCTYPE html>
<html  lang="zh-CN" >
    <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, maximum-scale=5, viewport-fit=cover">
    <title>grpc gateway 介绍 | 自留地</title>
    <meta name="description" content="一 概述本文主要介绍 grpc-gateway 使用以及实现原理。 二 grpc-gateway 基础1. 是什么grpc-gateway 是 protobuf 生成器 protoc 的一个插件。 2. 能做什么在 protobuf 的定义文件中添加 google.api.http 注解，grpc-gateway 可以读取 protobuf 定义文件并且生成反向代理服务，用来将 RESTful J">
<meta property="og:type" content="article">
<meta property="og:title" content="grpc gateway 介绍">
<meta property="og:url" content="https://juzipeek.github.io/2022/09/03/about-go-2019-04-05-grpc-gateway/index.html">
<meta property="og:site_name" content="自留地">
<meta property="og:description" content="一 概述本文主要介绍 grpc-gateway 使用以及实现原理。 二 grpc-gateway 基础1. 是什么grpc-gateway 是 protobuf 生成器 protoc 的一个插件。 2. 能做什么在 protobuf 的定义文件中添加 google.api.http 注解，grpc-gateway 可以读取 protobuf 定义文件并且生成反向代理服务，用来将 RESTful J">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-09-03T14:47:35.230Z">
<meta property="article:modified_time" content="2022-09-03T14:47:35.230Z">
<meta property="article:author" content="zhou cheng jie">
<meta property="article:tag" content="Go">
<meta property="article:tag" content="grpc-gateway">
<meta name="twitter:card" content="summary">

    
    <link rel="icon" href="/images/favicon.ico" type="image/x-icon">

    
<link rel="stylesheet" href="/css/common.min.css">



    
    
    
    
        <link href="//cdn.jsdelivr.net/npm/lightgallery.js@1.1.3/dist/css/lightgallery.min.css" rel="stylesheet">
    
    
    
<link rel="stylesheet" href="/css/iconfont.min.css">

    
    <script>
        (function(e,t,n,i,s,a,c){e[n]=e[n]||function(){(e[n].q=e[n].q||[]).push(arguments)}
        ;a=t.createElement(i);c=t.getElementsByTagName(i)[0];a.async=true;a.src=s
        ;c.parentNode.insertBefore(a,c)
        })(window,document,"galite","script","https://cdn.jsdelivr.net/npm/ga-lite@2/dist/ga-lite.min.js");

        galite('create', 'G-HFGFGEWD53', 'auto');
        galite('send', 'pageview');
    </script>
    
<meta name="generator" content="Hexo 5.4.2"></head>

    <body>
        <header class="header header-fixture">
    <div class="profile-search-wrap flex sm:block">
        
        
        <div class="profile sm:text-center md:px-1 lg:px-3 sm:pb-4 sm:pt-6">
            <a id="avatar" role="link" href="https://github.com/juzipeek" class="inline-block lg:w-16 lg:h-16 w-8 h-8 m-2" target="_blank" rel="noopener" rel="noreferrer" >
                <img src="/images/yellow.jpg" class="rounded-full" alt="avatar">
            </a>
            <h2 id="name" class="hidden lg:block">zhou cheng jie</h2>
            <h3 id="title" class="hidden lg:block">coder</h3>
            
            <small id="location" class="hidden lg:block">
                <i class="iconfont icon-map-icon"></i>
                BeiJing, China
            </small>
            
        </div>
        
        
<div class="search flex-1 flex lg:inline-block sm:hidden lg:px-4 lg:mt-2 lg:mb-4 lg:w-full">
    <form id="search-form" class="my-auto flex-1 lg:border lg:border-solid lg:border-gray-200">
        <div class="input-group table bg-gray-100 lg:bg-white w-full">
            <input id="search-input" type="text" placeholder="搜索" class="inline-block w-full bg-gray-100 lg:bg-white p-1">
            <span class="table-cell">
                <button name="search tigger button" disabled>
                    <i class="iconfont icon-search m-2"></i>
                </button>
            </span>
        </div>
    </form>
        
<div id="content-json" data-placeholder="搜索" class="invisible hidden">/content.json</div>
<script id="search-teamplate" type="text/html" data-path="/content.json">
    <div>
        <div class="search-header bg-gray-400">
            <input id="actual-search-input" model="keyword" ref="input" class="inline-block w-full h-10 px-2 py-1" placeholder="搜索" type="text">
        </div>
        <div class="search-result bg-gray-200">
            {{#each searchPosts}}
            <a href="/{{ path }}" class="result-item block px-2 pb-3 mb-1 pt-1 hover:bg-indigo-100">
                <i class="iconfont icon-file"></i>
                <h1 class="result-title inline font-medium text-lg">{{ title }}</h1>
                <p class="result-content text-gray-600 text-sm">{{{ text }}}</p>
            </a>
            {{/each}}
        </div>
    </div>
</script>

</div>


        <button name="menu toogle button" id="menu-toggle-btn" class="block sm:hidden p-3" role="button" aria-expanded="false">
            <i class="iconfont icon-hamburger"></i>
        </button>
    </div>
    <nav id="menu-nav" class="hidden sm:flex flex-col">
        
        
            <div class="menu-item menu-home" role="menuitem">
                <a href="/.">
                    <i class="iconfont icon-home" aria-hidden="true"></i>
                    <span class="menu-title">首页</span>
                </a>
            </div>
        
        
            <div class="menu-item menu-archives" role="menuitem">
                <a href="/archives">
                    <i class="iconfont icon-archive" aria-hidden="true"></i>
                    <span class="menu-title">归档</span>
                </a>
            </div>
        
        
            <div class="menu-item menu-categories" role="menuitem">
                <a href="/categories">
                    <i class="iconfont icon-folder" aria-hidden="true"></i>
                    <span class="menu-title">分类</span>
                </a>
            </div>
        
        
            <div class="menu-item menu-tags" role="menuitem">
                <a href="/tags">
                    <i class="iconfont icon-tag" aria-hidden="true"></i>
                    <span class="menu-title">标签</span>
                </a>
            </div>
        
        
            <div class="menu-item menu-about" role="menuitem">
                <a href="/about">
                    <i class="iconfont icon-cup" aria-hidden="true"></i>
                    <span class="menu-title">关于</span>
                </a>
            </div>
        
        
<div class="social-links flex sm:flex-col lg:hidden mt-5">
    
        <span class="social-item text-center">
            <a target="_blank" rel="noopener" href="https://github.com/juzipeek">
                <i class="iconfont social-icon icon-github"></i>
                <span class="menu-title hidden lg:inline">menu.github</span>
            </a>
        </span>
    
</div>


    </nav>
</header>

        <section class="main-section">
            
    <main class="flex-1 px-4 py-14 md:px-5 lg:px-8 lg:py-4 relative min-h-screen">
    

    <article class="content article article-archives article-type-list" itemscope="">
        <header class="article-header">
            
    
        <h1 class="article-title text-lg" itemprop="name">
            grpc gateway 介绍
        </h1>
    



            <p class="article-meta mb-3 text-xs">
                <span class="article-date">
    <i class="iconfont icon-calendar-check"></i>
	<a href="/2022/09/03/about-go-2019-04-05-grpc-gateway/" class="article-date">
	  <time datetime="2022-09-03T14:47:35.230Z" itemprop="datePublished">9月 3</time>
	</a>
</span>

                
    <span class="article-category">
    <i class="iconfont icon-folder"></i>
    <a class="article-category-link" href="/categories/Go/">Go</a>
  </span>


                
    <span class="article-tags">
    <i class="iconfont icon-tag"></i>
    <a class="article-tag-none-link" href="/tags/Go/" rel="tag">Go</a>, <a class="article-tag-none-link" href="/tags/grpc-gateway/" rel="tag">grpc-gateway</a>
  </span>


                <span class="_partial/post-comment"><i class="icon icon-comment"></i>
                    <a href="/2022/09/03/about-go-2019-04-05-grpc-gateway/#comments" class="article-comment-link">
                        评论
                    </a>
                </span>
                
    
        <span class="post-wordcount" itemprop="wordCount">字数统计: 2.1k(字)</span>
    
    
        <span class="post-readcount" itemprop="timeRequired">阅读时长: 11(分)</span>
    


            </p>
        </header>
        <div class="marked-body article-body">
            <h2 id="一-概述"><a href="#一-概述" class="headerlink" title="一 概述"></a>一 概述</h2><p>本文主要介绍 <code>grpc-gateway</code> 使用以及实现原理。</p>
<h2 id="二-grpc-gateway-基础"><a href="#二-grpc-gateway-基础" class="headerlink" title="二 grpc-gateway 基础"></a>二 grpc-gateway 基础</h2><h3 id="1-是什么"><a href="#1-是什么" class="headerlink" title="1. 是什么"></a>1. 是什么</h3><p><code>grpc-gateway</code> 是 <a target="_blank" rel="noopener" href="https://developers.google.com/protocol-buffers/"><code>protobuf</code></a> 生成器 <a target="_blank" rel="noopener" href="https://github.com/protocolbuffers/protobuf"><code>protoc</code></a> 的一个插件。</p>
<h3 id="2-能做什么"><a href="#2-能做什么" class="headerlink" title="2. 能做什么"></a>2. 能做什么</h3><p>在 <code>protobuf</code> 的定义文件中添加 <code>google.api.http</code> 注解，<code>grpc-gateway</code> 可以读取 <code>protobuf</code> 定义文件并且生成反向代理服务，<strong>用来将 <code>RESTful JSON</code> 接口转换为<code>gRPC</code> 格式</strong>。</p>
<h3 id="3-安装"><a href="#3-安装" class="headerlink" title="3. 安装"></a>3. 安装</h3><p><code>grpc-gateway</code> 依赖 <code>ProtocolBuffer</code>，需要先安装 <code>ProtoBuffer</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> tmp</span><br><span class="line"><span class="built_in">cd</span> tmp</span><br><span class="line"><span class="comment"># or wget https://github.com/protocolbuffers/protobuf/archive/v3.7.1.tar.gz</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/google/protobuf</span><br><span class="line"><span class="built_in">cd</span> protobuf</span><br><span class="line">./autogen.sh</span><br><span class="line">./configure</span><br><span class="line">make</span><br><span class="line">make check</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure>

<p>安装 <code>grpc-gateway</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 下载 genproto</span></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$GOPATH</span>/src/google.golang.org</span><br><span class="line">git <span class="built_in">clone</span> https://github.com/google/go-genproto.git</span><br><span class="line"><span class="built_in">mv</span> go-genproto/ genproto/</span><br><span class="line"></span><br><span class="line"><span class="comment"># gopm get -v github.com/grpc-ecosystem/grpc-gateway/protoc-gen-grpc-gateway</span></span><br><span class="line">go get -u github.com/grpc-ecosystem/grpc-gateway/protoc-gen-grpc-gateway</span><br><span class="line">go install github.com/grpc-ecosystem/grpc-gateway/protoc-gen-grpc-gateway</span><br><span class="line"></span><br><span class="line"><span class="comment"># gopm get -v github.com/grpc-ecosystem/grpc-gateway/protoc-gen-swagger</span></span><br><span class="line">go get -u github.com/grpc-ecosystem/grpc-gateway/protoc-gen-swagger</span><br><span class="line">go install github.com/grpc-ecosystem/grpc-gateway/protoc-gen-swagger</span><br><span class="line"></span><br><span class="line"><span class="comment"># gopm get -v github.com/golang/protobuf/protoc-gen-go</span></span><br><span class="line">go get -u github.com/golang/protobuf/protoc-gen-go</span><br><span class="line">go install github.com/golang/protobuf/protoc-gen-go</span><br></pre></td></tr></table></figure>

<h2 id="三-完整示例"><a href="#三-完整示例" class="headerlink" title="三 完整示例"></a>三 完整示例</h2><p>创建一个 SayHi 服务，接收 <code>name</code> 参数并返回 <code>echo</code> 消息。</p>
<h3 id="1-定义-gRPC-服务"><a href="#1-定义-gRPC-服务" class="headerlink" title="1.  定义 gRPC 服务"></a>1.  定义 <code>gRPC</code> 服务</h3><p>创建 <code>say_hi.proto</code> 文件，文件内容如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">package</span> endpoint;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;google/api/annotations.proto&quot;</span>; <span class="comment">// 导入注解包</span></span><br><span class="line"></span><br><span class="line">message HiReq &#123;</span><br><span class="line">	<span class="type">string</span> name = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message HiResp &#123;</span><br><span class="line">	<span class="type">string</span> echo = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">service SayHi &#123;</span><br><span class="line">    rpc SayHi (HiReq) returns (HiResp) &#123;</span><br><span class="line">        <span class="comment">// SayHi 接口的 RESTful 格式选项</span></span><br><span class="line">        option (google.api.http) = &#123;</span><br><span class="line">        	post: <span class="string">&quot;/api/sayhi&quot;</span></span><br><span class="line">        	body: <span class="string">&quot;*&quot;</span></span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-生成-gRPC-桩代码"><a href="#2-生成-gRPC-桩代码" class="headerlink" title="2. 生成 gRPC 桩代码"></a>2. 生成 <code>gRPC</code> 桩代码</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">protoc -I/usr/local/include -I. \</span><br><span class="line">	-I/home/zhoucj/Project/go_play/src \</span><br><span class="line">	-I/home/zhoucj/Project/go_play/src/github.com/grpc-ecosystem/grpc-gateway/third_party/googleapis \</span><br><span class="line">	--go_out=plugins=grpc:. proto/say_hi.proto</span><br></pre></td></tr></table></figure>

<p>执行完命令后会生成 <code>proto/say_hi.pb.go</code> 桩代码文件。</p>
<h3 id="3-生成反向代理服务"><a href="#3-生成反向代理服务" class="headerlink" title="3. 生成反向代理服务"></a>3. 生成反向代理服务</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">protoc -I/usr/local/include -I. \</span><br><span class="line">	-I/home/zhoucj/Project/go_play/src \</span><br><span class="line">	-I/home/zhoucj/Project/go_play/src/github.com/grpc-ecosystem/grpc-gateway/third_party/googleapis \</span><br><span class="line">	--grpc-gateway_out=logtostderr=<span class="literal">true</span>:. \</span><br><span class="line">	proto/say_hi.proto</span><br></pre></td></tr></table></figure>

<p>执行完命令后将生成 <code>proto/sai_hi.pb.gw.go</code> 反向代理文件。</p>
<h3 id="4-实现服务端接口"><a href="#4-实现服务端接口" class="headerlink" title="4.  实现服务端接口"></a>4.  实现服务端接口</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> srv</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;context&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	</span><br><span class="line">	<span class="string">&quot;endpoint/proto&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewSayHiSrv</span><span class="params">()</span></span> *SayHiSrv &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;SayHiSrv&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> SayHiSrv <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 服务实现接口</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *SayHiSrv)</span></span> SayHi(c context.Context, req *endpoint.HiReq) (*endpoint.HiResp, <span class="type">error</span>) &#123;</span><br><span class="line">	fmt.Println(<span class="string">&quot;request name:&quot;</span>, req.Name)</span><br><span class="line">	msg := fmt.Sprintf(<span class="string">&quot;%s nice to meet u.&quot;</span>, req.Name)</span><br><span class="line">	resp := &amp;endpoint.HiResp&#123;Echo: msg&#125;</span><br><span class="line">	fmt.Println(msg)</span><br><span class="line">	<span class="keyword">return</span> resp, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上只需按一般方式实现 <code>grpc server</code>。</p>
<h3 id="5-将反向代理服务与-grpc-server-关联"><a href="#5-将反向代理服务与-grpc-server-关联" class="headerlink" title="5. 将反向代理服务与 grpc server 关联"></a>5. 将反向代理服务与 <code>grpc server</code> 关联</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;context&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;net&quot;</span></span><br><span class="line">	<span class="string">&quot;net/http&quot;</span></span><br><span class="line">	</span><br><span class="line">	gw <span class="string">&quot;endpoint/proto&quot;</span></span><br><span class="line">	<span class="string">&quot;srv&quot;</span></span><br><span class="line">	</span><br><span class="line">	<span class="string">&quot;github.com/grpc-ecosystem/grpc-gateway/runtime&quot;</span></span><br><span class="line">	<span class="string">&quot;google.golang.org/grpc&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	grpcAddr = <span class="string">&quot;:8090&quot;</span> <span class="comment">// grpc 服务端口</span></span><br><span class="line">	httpAddr = <span class="string">&quot;:8080&quot;</span> <span class="comment">// http 协议端口</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// grpc server</span></span><br><span class="line">		rpcServer := grpc.NewServer()</span><br><span class="line">		<span class="comment">// 注册 grpc 处理函数</span></span><br><span class="line">		gw.RegisterSayHiServer(rpcServer, srv.NewSayHiSrv())</span><br><span class="line">		</span><br><span class="line">		lis, _ := net.Listen(<span class="string">&quot;tcp&quot;</span>, grpcAddr)</span><br><span class="line">		<span class="keyword">go</span> rpcServer.Serve(lis)</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// grpc gateway server</span></span><br><span class="line">		mux := runtime.NewServeMux()</span><br><span class="line">		ctx, _ := context.WithCancel(context.Background())</span><br><span class="line">		opts := []grpc.DialOption&#123;grpc.WithInsecure()&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// 注册反向代理服务</span></span><br><span class="line">		err := gw.RegisterSayHiHandlerFromEndpoint(ctx, mux, grpcAddr, opts)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			fmt.Println(<span class="string">&quot;RegisterSayHiHandlerFromEndpoint error:&quot;</span>, err.Error())</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// 启动反向代理服务</span></span><br><span class="line">		http.ListenAndServe(httpAddr, mux)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="6-编译测试"><a href="#6-编译测试" class="headerlink" title="6. 编译测试"></a>6. 编译测试</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">go build main.go</span><br><span class="line">curl -i -X POST -d <span class="string">&#x27;&#123;&quot;name&quot;:&quot;jay&quot;&#125;&#x27;</span> <span class="string">&quot;http://localhost:8080/api/sayhi&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 可以看到有 8090、8080 两个端口被监听</span></span><br><span class="line">netstat -ntl</span><br></pre></td></tr></table></figure>

<h2 id="四-深入grpc-gateway-内部实现"><a href="#四-深入grpc-gateway-内部实现" class="headerlink" title="四 深入grpc-gateway 内部实现"></a>四 深入<code>grpc-gateway</code> 内部实现</h2><p>在<em>完整示例</em>部分展示了如何将 <code>HTTP</code> 服务与 <code>grpc</code> 服务关联起来，其中的关键代码在下面：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">err := gw.RegisterSayHiHandlerFromEndpoint(ctx, mux, grpcAddr, opts)</span><br></pre></td></tr></table></figure>

<p>其调用过程为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">st=&gt;start: main</span><br><span class="line">e=&gt;end: End</span><br><span class="line">op1=&gt;operation: RegisterSayHiHandlerFromEndpoint</span><br><span class="line">op2=&gt;operation: RegisterSayHiHandler</span><br><span class="line">op3=&gt;operation: RegisterSayHiHandlerClient</span><br><span class="line"></span><br><span class="line">st-&gt;op1-&gt;op2-&gt;op3-&gt;e</span><br></pre></td></tr></table></figure>

<h3 id="1-RegisterSayHiHandlerFromEndpoint"><a href="#1-RegisterSayHiHandlerFromEndpoint" class="headerlink" title="1. RegisterSayHiHandlerFromEndpoint"></a>1. <code>RegisterSayHiHandlerFromEndpoint</code></h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RegisterSayHiHandlerFromEndpoint is same as RegisterSayHiHandler but</span></span><br><span class="line"><span class="comment">// automatically dials to &quot;endpoint&quot; and closes the connection when &quot;ctx&quot; gets done.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">RegisterSayHiHandlerFromEndpoint</span><span class="params">(ctx context.Context, mux *runtime.ServeMux, endpoint <span class="type">string</span>, opts []grpc.DialOption)</span></span> (err <span class="type">error</span>) &#123;</span><br><span class="line">	conn, err := grpc.Dial(endpoint, opts...)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> cerr := conn.Close(); cerr != <span class="literal">nil</span> &#123;</span><br><span class="line">				grpclog.Infof(<span class="string">&quot;Failed to close conn to %s: %v&quot;</span>, endpoint, cerr)</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">			&lt;-ctx.Done()</span><br><span class="line">			<span class="keyword">if</span> cerr := conn.Close(); cerr != <span class="literal">nil</span> &#123;</span><br><span class="line">				grpclog.Infof(<span class="string">&quot;Failed to close conn to %s: %v&quot;</span>, endpoint, cerr)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;()</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> RegisterSayHiHandler(ctx, mux, conn)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个函数的主要功能是创建一个 <code>grpc</code> 连接 <code>conn</code>，并将其作为参数传递给 <code>RegisterSayHiHandler</code> 函数，<code>ctx</code> 在整个调用过链中是为了保证在主调用协程关闭时（调用了 <code>cancel</code> 方法）进行资源清理。</p>
<h3 id="2-RegisterSayHiHandlerClient"><a href="#2-RegisterSayHiHandlerClient" class="headerlink" title="2. RegisterSayHiHandlerClient"></a>2. <code>RegisterSayHiHandlerClient</code></h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RegisterSayHiHandler registers the http handlers for service SayHi to &quot;mux&quot;.</span></span><br><span class="line"><span class="comment">// The handlers forward requests to the grpc endpoint over &quot;conn&quot;.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">RegisterSayHiHandler</span><span class="params">(ctx context.Context, mux *runtime.ServeMux, conn *grpc.ClientConn)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> RegisterSayHiHandlerClient(ctx, mux, NewSayHiClient(conn))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-RegisterSayHiHandlerClient"><a href="#3-RegisterSayHiHandlerClient" class="headerlink" title="3. RegisterSayHiHandlerClient"></a>3. <code>RegisterSayHiHandlerClient</code></h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RegisterSayHiHandlerClient registers the http handlers for service SayHi</span></span><br><span class="line"><span class="comment">// to &quot;mux&quot;. The handlers forward requests to the grpc endpoint over the given implementation of &quot;SayHiClient&quot;.</span></span><br><span class="line"><span class="comment">// Note: the gRPC framework executes interceptors within the gRPC handler. If the passed in &quot;SayHiClient&quot;</span></span><br><span class="line"><span class="comment">// doesn&#x27;t go through the normal gRPC flow (creating a gRPC client etc.) then it will be up to the passed in</span></span><br><span class="line"><span class="comment">// &quot;SayHiClient&quot; to call the correct interceptors.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">RegisterSayHiHandlerClient</span><span class="params">(ctx context.Context, </span></span></span><br><span class="line"><span class="params"><span class="function">                                mux *runtime.ServeMux, client SayHiClient)</span></span> <span class="type">error</span> &#123;</span><br><span class="line"></span><br><span class="line">	mux.Handle(<span class="string">&quot;POST&quot;</span>, </span><br><span class="line">               pattern_SayHi_SayHi_0, </span><br><span class="line">               <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, </span></span></span><br><span class="line"><span class="params"><span class="function">                    req *http.Request, </span></span></span><br><span class="line"><span class="params"><span class="function">                    pathParams <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">		ctx, cancel := context.WithCancel(req.Context())</span><br><span class="line">		<span class="keyword">defer</span> cancel()</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 将 RESTful 请求转换为 protobuf 格式</span></span><br><span class="line">		inboundMarshaler, outboundMarshaler := runtime.MarshalerForRequest(mux, req)</span><br><span class="line">		rctx, err := runtime.AnnotateContext(ctx, mux, req)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			runtime.HTTPError(ctx, mux, outboundMarshaler, w, req, err)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 调用 grpc 接口进行处理</span></span><br><span class="line">		resp, md, err := request_SayHi_SayHi_0(rctx, inboundMarshaler, client, req, pathParams)</span><br><span class="line">		ctx = runtime.NewServerMetadataContext(ctx, md)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			runtime.HTTPError(ctx, mux, outboundMarshaler, w, req, err)</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 将 protobuf 应答转换 RESTful 格式应答并发送给客户端</span></span><br><span class="line">		forward_SayHi_SayHi_0(ctx, mux, </span><br><span class="line">                              outboundMarshaler, </span><br><span class="line">                              w, req, resp, </span><br><span class="line">                              mux.GetForwardResponseOptions()...)</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Handle associates &quot;h&quot; to the pair of HTTP method and path pattern.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *ServeMux)</span></span> Handle(meth <span class="type">string</span>, pat Pattern, h HandlerFunc) &#123;</span><br><span class="line">	s.handlers[meth] = <span class="built_in">append</span>(s.handlers[meth], handler&#123;pat: pat, h: h&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>本函数是功能的核心，用来将服务接口路径（<code>pattern_SayHi_SayHi_0</code>）与处理函数相关联。处理函数注意有分为三个部分：将 RESTful 请求转换为 protobuf 格式、调用 grpc 接口进行处理、将 protobuf 应答转换 RESTful 格式应答并发送给客户端。</p>
<h3 id="4-处理-HTTP-请求"><a href="#4-处理-HTTP-请求" class="headerlink" title="4. 处理 HTTP 请求"></a>4. 处理 <code>HTTP</code> 请求</h3><p>以上 1 - 3 都在将请求之前的配置过程，在 <code>HTTP</code> 请求到来时怎么做呢？其实核心还是在 <code>ServeMux</code> 中，<code>ServeMux</code> 实现了 <code>net/http.Handler</code> 接口，主程序中已经通过代码 <code>http.ListenAndServe(httpAddr, mux)</code> 将 <code>mux</code> 设置为 <code>HTTP</code> 处理接口。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ServeHTTP dispatches the request to the first handler whose pattern matches to r.Method and r.Path.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *ServeMux)</span></span> ServeHTTP(w http.ResponseWriter, r *http.Request) &#123;</span><br><span class="line">	ctx := r.Context()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 1. 请求格式校验</span></span><br><span class="line">	path := r.URL.Path</span><br><span class="line">	<span class="keyword">if</span> !strings.HasPrefix(path, <span class="string">&quot;/&quot;</span>) &#123;</span><br><span class="line">		<span class="keyword">if</span> s.protoErrorHandler != <span class="literal">nil</span> &#123;</span><br><span class="line">			_, outboundMarshaler := MarshalerForRequest(s, r)</span><br><span class="line">			sterr := status.Error(codes.InvalidArgument, http.StatusText(http.StatusBadRequest))</span><br><span class="line">			s.protoErrorHandler(ctx, s, outboundMarshaler, w, r, sterr)</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			OtherErrorHandler(w, r, http.StatusText(http.StatusBadRequest), http.StatusBadRequest)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 路径解析</span></span><br><span class="line">	components := strings.Split(path[<span class="number">1</span>:], <span class="string">&quot;/&quot;</span>)</span><br><span class="line">	l := <span class="built_in">len</span>(components)</span><br><span class="line">	<span class="keyword">var</span> verb <span class="type">string</span></span><br><span class="line">	<span class="keyword">if</span> idx := strings.LastIndex(components[l<span class="number">-1</span>], <span class="string">&quot;:&quot;</span>); idx == <span class="number">0</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> s.protoErrorHandler != <span class="literal">nil</span> &#123;</span><br><span class="line">			_, outboundMarshaler := MarshalerForRequest(s, r)</span><br><span class="line">			sterr := status.Error(codes.Unimplemented, http.StatusText(http.StatusNotImplemented))</span><br><span class="line">			s.protoErrorHandler(ctx, s, outboundMarshaler, w, r, sterr)</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			OtherErrorHandler(w, r, http.StatusText(http.StatusNotFound), http.StatusNotFound)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> idx &gt; <span class="number">0</span> &#123;</span><br><span class="line">		c := components[l<span class="number">-1</span>]</span><br><span class="line">		components[l<span class="number">-1</span>], verb = c[:idx], c[idx+<span class="number">1</span>:]</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> override := r.Header.Get(<span class="string">&quot;X-HTTP-Method-Override&quot;</span>); override != <span class="string">&quot;&quot;</span> &amp;&amp; s.isPathLengthFallback(r) &#123;</span><br><span class="line">		r.Method = strings.ToUpper(override)</span><br><span class="line">		<span class="keyword">if</span> err := r.ParseForm(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">if</span> s.protoErrorHandler != <span class="literal">nil</span> &#123;</span><br><span class="line">				_, outboundMarshaler := MarshalerForRequest(s, r)</span><br><span class="line">				sterr := status.Error(codes.InvalidArgument, err.Error())</span><br><span class="line">				s.protoErrorHandler(ctx, s, outboundMarshaler, w, r, sterr)</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				OtherErrorHandler(w, r, err.Error(), http.StatusBadRequest)</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 根据路径匹配处理函数</span></span><br><span class="line">	<span class="keyword">for</span> _, h := <span class="keyword">range</span> s.handlers[r.Method] &#123;</span><br><span class="line">		pathParams, err := h.pat.Match(components, verb)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line">		h.h(w, r, pathParams)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">	<span class="comment">// lookup other methods to handle fallback from GET to POST and</span></span><br><span class="line">	<span class="comment">// to determine if it is MethodNotAllowed or NotFound.</span></span><br><span class="line">	<span class="keyword">for</span> m, handlers := <span class="keyword">range</span> s.handlers &#123;</span><br><span class="line">		<span class="keyword">if</span> m == r.Method &#123;</span><br><span class="line">			<span class="keyword">continue</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">for</span> _, h := <span class="keyword">range</span> handlers &#123;</span><br><span class="line">			pathParams, err := h.pat.Match(components, verb)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">continue</span></span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// X-HTTP-Method-Override is optional. Always allow fallback to POST.</span></span><br><span class="line">			<span class="keyword">if</span> s.isPathLengthFallback(r) &#123;</span><br><span class="line">				<span class="keyword">if</span> err := r.ParseForm(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">					<span class="keyword">if</span> s.protoErrorHandler != <span class="literal">nil</span> &#123;</span><br><span class="line">						_, outboundMarshaler := MarshalerForRequest(s, r)</span><br><span class="line">						sterr := status.Error(codes.InvalidArgument, err.Error())</span><br><span class="line">						s.protoErrorHandler(ctx, s, outboundMarshaler, w, r, sterr)</span><br><span class="line">					&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">						OtherErrorHandler(w, r, err.Error(), http.StatusBadRequest)</span><br><span class="line">					&#125;</span><br><span class="line">					<span class="keyword">return</span></span><br><span class="line">				&#125;</span><br><span class="line">				h.h(w, r, pathParams)</span><br><span class="line">				<span class="keyword">return</span></span><br><span class="line">			&#125;</span><br><span class="line">            </span><br><span class="line">			<span class="keyword">if</span> s.protoErrorHandler != <span class="literal">nil</span> &#123;</span><br><span class="line">				_, outboundMarshaler := MarshalerForRequest(s, r)</span><br><span class="line">				sterr := status.Error(codes.Unimplemented, http.StatusText(http.StatusMethodNotAllowed))</span><br><span class="line">				s.protoErrorHandler(ctx, s, outboundMarshaler, w, r, sterr)</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				OtherErrorHandler(w, r, http.StatusText(http.StatusMethodNotAllowed), http.StatusMethodNotAllowed)</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> s.protoErrorHandler != <span class="literal">nil</span> &#123;</span><br><span class="line">		_, outboundMarshaler := MarshalerForRequest(s, r)</span><br><span class="line">		sterr := status.Error(codes.Unimplemented, http.StatusText(http.StatusNotImplemented))</span><br><span class="line">		s.protoErrorHandler(ctx, s, outboundMarshaler, w, r, sterr)</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		OtherErrorHandler(w, r, http.StatusText(http.StatusNotFound), http.StatusNotFound)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="五-总结"><a href="#五-总结" class="headerlink" title="五 总结"></a>五 总结</h2><p><code>grpc-gateway</code> 的本质是启动另外一个 <code>HTTP</code> 服务，用来将 <code>HTTP</code> 协议请求转换为 <code>grpc</code> 格式请求。</p>
<p>在 <code>ServeMux</code> 中 <code>Handler</code> 的存储结构为 <code>slice</code>，如果 <code>Handler</code> 过多会成为性能瓶颈。</p>
<h2 id="六-其他说明"><a href="#六-其他说明" class="headerlink" title="六 其他说明"></a>六 其他说明</h2><h3 id="ServeMux"><a href="#ServeMux" class="headerlink" title="ServeMux"></a><code>ServeMux</code></h3><p>ServeMux(<code>grpc-ecosystem/grpc-gateway/runtime.ServeMux</code>)是 <code>grpc-gateway</code> 的请求多路复用器，用来匹配 <code>HTTP</code> 请求并调用相应的处理函数。</p>

        </div>
        

    </article>
    
    <section id="comments">
        
    </section>


    

</main>


<aside style="" id="sidebar" class="aside aside-fixture">
    <div class="toc-sidebar">
        <nav id="toc" class="article-toc">
            <h3 class="toc-title">文章目录</h3>
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80-%E6%A6%82%E8%BF%B0"><span class="toc-number">1.</span> <span class="toc-text">一 概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C-grpc-gateway-%E5%9F%BA%E7%A1%80"><span class="toc-number">2.</span> <span class="toc-text">二 grpc-gateway 基础</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-number">2.1.</span> <span class="toc-text">1. 是什么</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E8%83%BD%E5%81%9A%E4%BB%80%E4%B9%88"><span class="toc-number">2.2.</span> <span class="toc-text">2. 能做什么</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%AE%89%E8%A3%85"><span class="toc-number">2.3.</span> <span class="toc-text">3. 安装</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89-%E5%AE%8C%E6%95%B4%E7%A4%BA%E4%BE%8B"><span class="toc-number">3.</span> <span class="toc-text">三 完整示例</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%AE%9A%E4%B9%89-gRPC-%E6%9C%8D%E5%8A%A1"><span class="toc-number">3.1.</span> <span class="toc-text">1.  定义 gRPC 服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E7%94%9F%E6%88%90-gRPC-%E6%A1%A9%E4%BB%A3%E7%A0%81"><span class="toc-number">3.2.</span> <span class="toc-text">2. 生成 gRPC 桩代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E7%94%9F%E6%88%90%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1"><span class="toc-number">3.3.</span> <span class="toc-text">3. 生成反向代理服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E5%AE%9E%E7%8E%B0%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%8E%A5%E5%8F%A3"><span class="toc-number">3.4.</span> <span class="toc-text">4.  实现服务端接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E5%B0%86%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E6%9C%8D%E5%8A%A1%E4%B8%8E-grpc-server-%E5%85%B3%E8%81%94"><span class="toc-number">3.5.</span> <span class="toc-text">5. 将反向代理服务与 grpc server 关联</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-%E7%BC%96%E8%AF%91%E6%B5%8B%E8%AF%95"><span class="toc-number">3.6.</span> <span class="toc-text">6. 编译测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B-%E6%B7%B1%E5%85%A5grpc-gateway-%E5%86%85%E9%83%A8%E5%AE%9E%E7%8E%B0"><span class="toc-number">4.</span> <span class="toc-text">四 深入grpc-gateway 内部实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-RegisterSayHiHandlerFromEndpoint"><span class="toc-number">4.1.</span> <span class="toc-text">1. RegisterSayHiHandlerFromEndpoint</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-RegisterSayHiHandlerClient"><span class="toc-number">4.2.</span> <span class="toc-text">2. RegisterSayHiHandlerClient</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-RegisterSayHiHandlerClient"><span class="toc-number">4.3.</span> <span class="toc-text">3. RegisterSayHiHandlerClient</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E5%A4%84%E7%90%86-HTTP-%E8%AF%B7%E6%B1%82"><span class="toc-number">4.4.</span> <span class="toc-text">4. 处理 HTTP 请求</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94-%E6%80%BB%E7%BB%93"><span class="toc-number">5.</span> <span class="toc-text">五 总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD-%E5%85%B6%E4%BB%96%E8%AF%B4%E6%98%8E"><span class="toc-number">6.</span> <span class="toc-text">六 其他说明</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ServeMux"><span class="toc-number">6.1.</span> <span class="toc-text">ServeMux</span></a></li></ol></li></ol>
        </nav>
    </div>
</aside>





        </section>
        <footer class="hidden lg:block fixed bottom-0 left-0 sm:w-1/12 lg:w-1/6 bg-gray-100 z-40">
    
    <div class="footer-social-links">
        
            <a target="_blank" rel="noopener" href="https://github.com/juzipeek">
                <i class="iconfont icon-github"></i>
            </a>
        
    </div>
    
    
</footer>

        <div id="mask" class="hidden mask fixed inset-0 bg-gray-900 opacity-75 z-40"></div>
        <div id="search-view-container" class="hidden shadow-xl"></div>
        
<script src="/js/dom-event.min.js"></script>



<script src="/js/local-search.min.js"></script>



    <script src="//cdn.jsdelivr.net/npm/lightgallery.js@1.1.3/dist/js/lightgallery.min.js"></script>
    
<script src="/js/light-gallery.min.js"></script>






    </body>
</html>
