<!DOCTYPE html>
<html  lang="zh-CN" >
    <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1, initial-scale=1, maximum-scale=5, viewport-fit=cover">
    <title>OpenResty Api - output api | 自留地</title>
    <meta name="description" content="一 概述output api 主要用于向客户端发送应答数据，或者对应答进行控制。输出函数：ngx.send_headers、ngx.print、ngx.say ；响应控制函数：ngx.flush、ngx.eof。 二 输出函数1. ngx.send_headers函数原型： 1ok, err &#x3D; ngx.send_headers()  允许介入的阶段：rewrite_by_lua_*、access">
<meta property="og:type" content="article">
<meta property="og:title" content="OpenResty Api - output api">
<meta property="og:url" content="https://juzipeek.github.io/2022/09/03/nginx-2019-09-01-openresty-api-output-api/index.html">
<meta property="og:site_name" content="自留地">
<meta property="og:description" content="一 概述output api 主要用于向客户端发送应答数据，或者对应答进行控制。输出函数：ngx.send_headers、ngx.print、ngx.say ；响应控制函数：ngx.flush、ngx.eof。 二 输出函数1. ngx.send_headers函数原型： 1ok, err &#x3D; ngx.send_headers()  允许介入的阶段：rewrite_by_lua_*、access">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-09-03T12:55:44.508Z">
<meta property="article:modified_time" content="2022-09-03T12:55:44.509Z">
<meta property="article:author" content="zhou cheng jie">
<meta property="article:tag" content="C">
<meta property="article:tag" content="Lua">
<meta property="article:tag" content="NGINX">
<meta property="article:tag" content="OpenResty">
<meta name="twitter:card" content="summary">

    
    <link rel="icon" href="/images/favicon.ico" type="image/x-icon">

    
<link rel="stylesheet" href="/css/common.min.css">



    
    
    
    
        <link href="//cdn.jsdelivr.net/npm/lightgallery.js@1.1.3/dist/css/lightgallery.min.css" rel="stylesheet">
    
    
    
<link rel="stylesheet" href="/css/iconfont.min.css">

    
    <script>
        (function(e,t,n,i,s,a,c){e[n]=e[n]||function(){(e[n].q=e[n].q||[]).push(arguments)}
        ;a=t.createElement(i);c=t.getElementsByTagName(i)[0];a.async=true;a.src=s
        ;c.parentNode.insertBefore(a,c)
        })(window,document,"galite","script","https://cdn.jsdelivr.net/npm/ga-lite@2/dist/ga-lite.min.js");

        galite('create', 'G-HFGFGEWD53', 'auto');
        galite('send', 'pageview');
    </script>
    
<meta name="generator" content="Hexo 5.4.2"></head>

    <body>
        <header class="header header-fixture">
    <div class="profile-search-wrap flex sm:block">
        
        
        <div class="profile sm:text-center md:px-1 lg:px-3 sm:pb-4 sm:pt-6">
            <a id="avatar" role="link" href="https://github.com/juzipeek" class="inline-block lg:w-16 lg:h-16 w-8 h-8 m-2" target="_blank" rel="noopener" rel="noreferrer" >
                <img src="/images/yellow.jpg" class="rounded-full" alt="avatar">
            </a>
            <h2 id="name" class="hidden lg:block">zhou cheng jie</h2>
            <h3 id="title" class="hidden lg:block">coder</h3>
            
            <small id="location" class="hidden lg:block">
                <i class="iconfont icon-map-icon"></i>
                BeiJing, China
            </small>
            
        </div>
        
        
<div class="search flex-1 flex lg:inline-block sm:hidden lg:px-4 lg:mt-2 lg:mb-4 lg:w-full">
    <form id="search-form" class="my-auto flex-1 lg:border lg:border-solid lg:border-gray-200">
        <div class="input-group table bg-gray-100 lg:bg-white w-full">
            <input id="search-input" type="text" placeholder="搜索" class="inline-block w-full bg-gray-100 lg:bg-white p-1">
            <span class="table-cell">
                <button name="search tigger button" disabled>
                    <i class="iconfont icon-search m-2"></i>
                </button>
            </span>
        </div>
    </form>
        
<div id="content-json" data-placeholder="搜索" class="invisible hidden">/content.json</div>
<script id="search-teamplate" type="text/html" data-path="/content.json">
    <div>
        <div class="search-header bg-gray-400">
            <input id="actual-search-input" model="keyword" ref="input" class="inline-block w-full h-10 px-2 py-1" placeholder="搜索" type="text">
        </div>
        <div class="search-result bg-gray-200">
            {{#each searchPosts}}
            <a href="/{{ path }}" class="result-item block px-2 pb-3 mb-1 pt-1 hover:bg-indigo-100">
                <i class="iconfont icon-file"></i>
                <h1 class="result-title inline font-medium text-lg">{{ title }}</h1>
                <p class="result-content text-gray-600 text-sm">{{{ text }}}</p>
            </a>
            {{/each}}
        </div>
    </div>
</script>

</div>


        <button name="menu toogle button" id="menu-toggle-btn" class="block sm:hidden p-3" role="button" aria-expanded="false">
            <i class="iconfont icon-hamburger"></i>
        </button>
    </div>
    <nav id="menu-nav" class="hidden sm:flex flex-col">
        
        
            <div class="menu-item menu-home" role="menuitem">
                <a href="/.">
                    <i class="iconfont icon-home" aria-hidden="true"></i>
                    <span class="menu-title">首页</span>
                </a>
            </div>
        
        
            <div class="menu-item menu-archives" role="menuitem">
                <a href="/archives">
                    <i class="iconfont icon-archive" aria-hidden="true"></i>
                    <span class="menu-title">归档</span>
                </a>
            </div>
        
        
            <div class="menu-item menu-categories" role="menuitem">
                <a href="/categories">
                    <i class="iconfont icon-folder" aria-hidden="true"></i>
                    <span class="menu-title">分类</span>
                </a>
            </div>
        
        
            <div class="menu-item menu-tags" role="menuitem">
                <a href="/tags">
                    <i class="iconfont icon-tag" aria-hidden="true"></i>
                    <span class="menu-title">标签</span>
                </a>
            </div>
        
        
            <div class="menu-item menu-about" role="menuitem">
                <a href="/about">
                    <i class="iconfont icon-cup" aria-hidden="true"></i>
                    <span class="menu-title">关于</span>
                </a>
            </div>
        
        
<div class="social-links flex sm:flex-col lg:hidden mt-5">
    
        <span class="social-item text-center">
            <a target="_blank" rel="noopener" href="https://github.com/juzipeek">
                <i class="iconfont social-icon icon-github"></i>
                <span class="menu-title hidden lg:inline">menu.github</span>
            </a>
        </span>
    
</div>


    </nav>
</header>

        <section class="main-section">
            
    <main class="flex-1 px-4 py-14 md:px-5 lg:px-8 lg:py-4 relative min-h-screen">
    

    <article class="content article article-archives article-type-list" itemscope="">
        <header class="article-header">
            
    
        <h1 class="article-title text-lg" itemprop="name">
            OpenResty Api - output api
        </h1>
    



            <p class="article-meta mb-3 text-xs">
                <span class="article-date">
    <i class="iconfont icon-calendar-check"></i>
	<a href="/2022/09/03/nginx-2019-09-01-openresty-api-output-api/" class="article-date">
	  <time datetime="2022-09-03T12:55:44.508Z" itemprop="datePublished">9月 3</time>
	</a>
</span>

                
    <span class="article-category">
    <i class="iconfont icon-folder"></i>
    <a class="article-category-link" href="/categories/NGINX/">NGINX</a>
  </span>


                
    <span class="article-tags">
    <i class="iconfont icon-tag"></i>
    <a class="article-tag-none-link" href="/tags/C/" rel="tag">C</a>, <a class="article-tag-none-link" href="/tags/Lua/" rel="tag">Lua</a>, <a class="article-tag-none-link" href="/tags/NGINX/" rel="tag">NGINX</a>, <a class="article-tag-none-link" href="/tags/OpenResty/" rel="tag">OpenResty</a>
  </span>


                <span class="_partial/post-comment"><i class="icon icon-comment"></i>
                    <a href="/2022/09/03/nginx-2019-09-01-openresty-api-output-api/#comments" class="article-comment-link">
                        评论
                    </a>
                </span>
                
    
        <span class="post-wordcount" itemprop="wordCount">字数统计: 2.8k(字)</span>
    
    
        <span class="post-readcount" itemprop="timeRequired">阅读时长: 14(分)</span>
    


            </p>
        </header>
        <div class="marked-body article-body">
            <h2 id="一-概述"><a href="#一-概述" class="headerlink" title="一 概述"></a>一 概述</h2><p><code>output api</code> 主要用于向<strong>客户端</strong>发送应答数据，或者对应答进行控制。输出函数：<code>ngx.send_headers</code>、<code>ngx.print</code>、<code>ngx.say</code> ；响应控制函数：<code>ngx.flush</code>、<code>ngx.eof</code>。</p>
<h2 id="二-输出函数"><a href="#二-输出函数" class="headerlink" title="二 输出函数"></a>二 输出函数</h2><h3 id="1-ngx-send-headers"><a href="#1-ngx-send-headers" class="headerlink" title="1. ngx.send_headers"></a>1. <code>ngx.send_headers</code></h3><p>函数原型：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ok, err = ngx.send_headers()</span><br></pre></td></tr></table></figure>

<p>允许介入的阶段：<code>rewrite_by_lua_*</code>、<code>access_by_lua_*</code>、<code>content_by_lua_*</code>。</p>
<p>向客户端发送应答头。在发送响应时需要对 <code>content type</code>、<code>content length</code> 进行特别关注，如果这两者错误会直接导致客户端解析异常。<code>lua_nginx_module</code> 会调用 <code>ngx_http_lua_set_content_type</code> 函数对 <code>content type</code> 进行特殊处理。在对 <code>conten_type</code> 进行特殊处理时最终会调用 <code>ngx_http_set_content_type</code> 函数，首先根据请求文件扩展名获得对于的 <code>content type</code>，如果失败则使用默认 <code>content type</code> 设置。其实现如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ngx_int_t</span></span><br><span class="line"><span class="title function_">ngx_http_set_content_type</span><span class="params">(<span class="type">ngx_http_request_t</span> *r)</span></span><br><span class="line">&#123;</span><br><span class="line">    u_char                     c, *exten;</span><br><span class="line">    <span class="type">ngx_str_t</span>                 *type;</span><br><span class="line">    <span class="type">ngx_uint_t</span>                 i, hash;</span><br><span class="line">    <span class="type">ngx_http_core_loc_conf_t</span>  *clcf;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;headers_out.content_type.len) &#123;</span><br><span class="line">        <span class="keyword">return</span> NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    clcf = ngx_http_get_module_loc_conf(r, ngx_http_core_module);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 请求文件的扩展名，例如请求行：GET /index.html HTTP/1.1，扩展名为 html</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;exten.len) &#123;</span><br><span class="line"></span><br><span class="line">        hash = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将扩展名转换为小写计算 hash key</span></span><br><span class="line">        <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; r-&gt;exten.len; i++) &#123;</span><br><span class="line">            c = r-&gt;exten.data[i];</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (c &gt;= <span class="string">&#x27;A&#x27;</span> &amp;&amp; c &lt;= <span class="string">&#x27;Z&#x27;</span>) &#123;</span><br><span class="line"></span><br><span class="line">                exten = ngx_pnalloc(r-&gt;pool, r-&gt;exten.len);</span><br><span class="line">                <span class="keyword">if</span> (exten == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                hash = ngx_hash_strlow(exten, r-&gt;exten.data, r-&gt;exten.len);</span><br><span class="line"></span><br><span class="line">                r-&gt;exten.data = exten;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// ngx_hash 会累加 hash 值</span></span><br><span class="line">            hash = ngx_hash(hash, c);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 根据 mime 表查找 conten type</span></span><br><span class="line">        type = ngx_hash_find(&amp;clcf-&gt;types_hash, hash,</span><br><span class="line">                             r-&gt;exten.data, r-&gt;exten.len);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (type) &#123;</span><br><span class="line">            r-&gt;headers_out.content_type_len = type-&gt;len;</span><br><span class="line">            r-&gt;headers_out.content_type = *type;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> NGX_OK;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置默认 content type</span></span><br><span class="line">    r-&gt;headers_out.content_type_len = clcf-&gt;default_type.len;</span><br><span class="line">    r-&gt;headers_out.content_type = clcf-&gt;default_type;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> NGX_OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对于 <code>content_length</code> 头，如果未设置过应答 <code>header</code>（调用 <code>ngx.resp.header[&#39;new_header&#39;] = &#39;value&#39;</code> 函数），需要将 <code>content_length</code> 头清除，使用 <code>chrunked</code> 编码方式传输。</p>
<p>**调用 <code>ngx.send_headers</code> 后会进入 <code>header filter</code> 阶段，此函数的实际输出是调用 <code>ngx_http_top_header_filter</code>**。</p>
<h3 id="2-ngx-print"><a href="#2-ngx-print" class="headerlink" title="2. ngx.print"></a>2. <code>ngx.print</code></h3><p>函数原型：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ok, err = ngx.<span class="built_in">print</span>(...)</span><br></pre></td></tr></table></figure>

<p>允许介入阶段：<code>rewrite_by_lua_*</code>、<code>access_by_lua_*</code>、<code>content_by_lua_*</code>。</p>
<p><code>ngx.print</code> 会调用 <code>ngx_http_lua_ngx_echo</code> 函数进行应答 <code>ngx_http_top_body_filter</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span></span><br><span class="line"><span class="title function_">ngx_http_lua_ngx_echo</span><span class="params">(lua_State *L, <span class="type">unsigned</span> newline)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">ngx_http_request_t</span>          *r;</span><br><span class="line">    <span class="type">ngx_http_lua_ctx_t</span>          *ctx;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>                  *p;</span><br><span class="line">    <span class="type">size_t</span>                       len;</span><br><span class="line">    <span class="type">size_t</span>                       size;</span><br><span class="line">    <span class="type">ngx_buf_t</span>                   *b;</span><br><span class="line">    <span class="type">ngx_chain_t</span>                 *cl;</span><br><span class="line">    <span class="type">ngx_int_t</span>                    rc;</span><br><span class="line">    <span class="type">int</span>                          i;</span><br><span class="line">    <span class="type">int</span>                          nargs;</span><br><span class="line">    <span class="type">int</span>                          type;</span><br><span class="line">    <span class="type">const</span> <span class="type">char</span>                  *msg;</span><br><span class="line"></span><br><span class="line">    r = ngx_http_lua_get_req(L);</span><br><span class="line">    <span class="keyword">if</span> (r == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> luaL_error(L, <span class="string">&quot;no request object found&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ctx = ngx_http_get_module_ctx(r, ngx_http_lua_module);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ctx == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> luaL_error(L, <span class="string">&quot;no request ctx found&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">		<span class="comment">// 当前阶段检测，判断是否在 rewrite、access、content 阶段</span></span><br><span class="line">    <span class="comment">// NGX_HTTP_LUA_CONTEXT_REWRITE 等几个宏是 lua-nginx 模块定义</span></span><br><span class="line">    ngx_http_lua_check_context(L, ctx, NGX_HTTP_LUA_CONTEXT_REWRITE</span><br><span class="line">                               | NGX_HTTP_LUA_CONTEXT_ACCESS</span><br><span class="line">                               | NGX_HTTP_LUA_CONTEXT_CONTENT);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ctx-&gt;acquired_raw_req_socket) &#123;</span><br><span class="line">        lua_pushnil(L); <span class="comment">// 状态标识</span></span><br><span class="line">        lua_pushliteral(L, <span class="string">&quot;raw request socket acquired&quot;</span>); <span class="comment">// 错误信息字符串</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span>; <span class="comment">// 栈中元素数，返回给 lua return value 数量</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;header_only) &#123;</span><br><span class="line">        lua_pushnil(L); <span class="comment">// 状态标识</span></span><br><span class="line">        lua_pushliteral(L, <span class="string">&quot;header only&quot;</span>); <span class="comment">// 错误信息字符串</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span>; <span class="comment">// 栈中元素数，返回给 lua return value 数量</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ctx-&gt;eof) &#123;</span><br><span class="line">        lua_pushnil(L); <span class="comment">// 状态标识</span></span><br><span class="line">        lua_pushliteral(L, <span class="string">&quot;seen eof&quot;</span>); <span class="comment">// 错误信息</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    nargs = lua_gettop(L);</span><br><span class="line">    size = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 计算 ngx.print 或 ngx.say 的参数长度</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">1</span>; i &lt;= nargs; i++) &#123;</span><br><span class="line"></span><br><span class="line">        type = lua_type(L, i);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">            <span class="keyword">case</span> LUA_TNUMBER:</span><br><span class="line">            <span class="keyword">case</span> LUA_TSTRING:</span><br><span class="line"></span><br><span class="line">                lua_tolstring(L, i, &amp;len);</span><br><span class="line">                size += len;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> LUA_TNIL:</span><br><span class="line"></span><br><span class="line">                size += <span class="keyword">sizeof</span>(<span class="string">&quot;nil&quot;</span>) - <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> LUA_TBOOLEAN:</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (lua_toboolean(L, i)) &#123;</span><br><span class="line">                    size += <span class="keyword">sizeof</span>(<span class="string">&quot;true&quot;</span>) - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    size += <span class="keyword">sizeof</span>(<span class="string">&quot;false&quot;</span>) - <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> LUA_TTABLE:</span><br><span class="line"></span><br><span class="line">                size += ngx_http_lua_calc_strlen_in_table(L, i, i,</span><br><span class="line">                                                          <span class="number">0</span> <span class="comment">/* strict */</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> LUA_TLIGHTUSERDATA:</span><br><span class="line"></span><br><span class="line">                dd(<span class="string">&quot;userdata: %p&quot;</span>, lua_touserdata(L, i));</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (lua_touserdata(L, i) == <span class="literal">NULL</span>) &#123;</span><br><span class="line">                    size += <span class="keyword">sizeof</span>(<span class="string">&quot;null&quot;</span>) - <span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line"></span><br><span class="line">                msg = lua_pushfstring(L, <span class="string">&quot;string, number, boolean, nil, &quot;</span></span><br><span class="line">                                      <span class="string">&quot;ngx.null, or array table expected, &quot;</span></span><br><span class="line">                                      <span class="string">&quot;but got %s&quot;</span>, lua_typename(L, type));</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> luaL_argerror(L, i, msg);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ngx.say newline 为 1；ngx.print newline 为 0</span></span><br><span class="line">    <span class="keyword">if</span> (newline) &#123;</span><br><span class="line">        size += <span class="keyword">sizeof</span>(<span class="string">&quot;\n&quot;</span>) - <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 无 body，仅发送 header</span></span><br><span class="line">    <span class="keyword">if</span> (size == <span class="number">0</span>) &#123;</span><br><span class="line">        rc = ngx_http_lua_send_header_if_needed(r, ctx);</span><br><span class="line">        <span class="keyword">if</span> (rc == NGX_ERROR || rc &gt; NGX_OK) &#123;</span><br><span class="line">            lua_pushnil(L);</span><br><span class="line">            lua_pushliteral(L, <span class="string">&quot;nginx output filter error&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        lua_pushinteger(L, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ctx-&gt;seen_body_data = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建 size 大小的 ngx_chain_t 对象</span></span><br><span class="line">    cl = ngx_http_lua_chain_get_free_buf(r-&gt;connection-&gt;<span class="built_in">log</span>, r-&gt;pool,</span><br><span class="line">                                         &amp;ctx-&gt;free_bufs, size);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (cl == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> luaL_error(L, <span class="string">&quot;no memory&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    b = cl-&gt;buf;</span><br><span class="line">    <span class="comment">// 将调用参数进行转换，并拷贝的 output_chain</span></span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">1</span>; i &lt;= nargs; i++) &#123;</span><br><span class="line">        type = lua_type(L, i);</span><br><span class="line">        <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">            <span class="keyword">case</span> LUA_TNUMBER:</span><br><span class="line">            <span class="keyword">case</span> LUA_TSTRING:</span><br><span class="line">                p = lua_tolstring(L, i, &amp;len);</span><br><span class="line">                b-&gt;last = ngx_copy(b-&gt;last, (u_char *) p, len);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> LUA_TNIL:</span><br><span class="line">                *b-&gt;last++ = <span class="string">&#x27;n&#x27;</span>;</span><br><span class="line">                *b-&gt;last++ = <span class="string">&#x27;i&#x27;</span>;</span><br><span class="line">                *b-&gt;last++ = <span class="string">&#x27;l&#x27;</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> LUA_TBOOLEAN:</span><br><span class="line">                <span class="keyword">if</span> (lua_toboolean(L, i)) &#123;</span><br><span class="line">                    *b-&gt;last++ = <span class="string">&#x27;t&#x27;</span>;</span><br><span class="line">                    *b-&gt;last++ = <span class="string">&#x27;r&#x27;</span>;</span><br><span class="line">                    *b-&gt;last++ = <span class="string">&#x27;u&#x27;</span>;</span><br><span class="line">                    *b-&gt;last++ = <span class="string">&#x27;e&#x27;</span>;</span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    *b-&gt;last++ = <span class="string">&#x27;f&#x27;</span>;</span><br><span class="line">                    *b-&gt;last++ = <span class="string">&#x27;a&#x27;</span>;</span><br><span class="line">                    *b-&gt;last++ = <span class="string">&#x27;l&#x27;</span>;</span><br><span class="line">                    *b-&gt;last++ = <span class="string">&#x27;s&#x27;</span>;</span><br><span class="line">                    *b-&gt;last++ = <span class="string">&#x27;e&#x27;</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> LUA_TTABLE:</span><br><span class="line">                b-&gt;last = ngx_http_lua_copy_str_in_table(L, i, b-&gt;last);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">case</span> LUA_TLIGHTUSERDATA:</span><br><span class="line">                *b-&gt;last++ = <span class="string">&#x27;n&#x27;</span>;</span><br><span class="line">                *b-&gt;last++ = <span class="string">&#x27;u&#x27;</span>;</span><br><span class="line">                *b-&gt;last++ = <span class="string">&#x27;l&#x27;</span>;</span><br><span class="line">                *b-&gt;last++ = <span class="string">&#x27;l&#x27;</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> luaL_error(L, <span class="string">&quot;impossible to reach here&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (newline) &#123;</span><br><span class="line">        *b-&gt;last++ = <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> 0</span></span><br><span class="line">    <span class="keyword">if</span> (b-&gt;last != b-&gt;end) &#123;</span><br><span class="line">        <span class="keyword">return</span> luaL_error(L, <span class="string">&quot;buffer error: %p != %p&quot;</span>, b-&gt;last, b-&gt;end);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    ngx_log_debug0(NGX_LOG_DEBUG_HTTP, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   newline ? <span class="string">&quot;lua say response&quot;</span> : <span class="string">&quot;lua print response&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 最终会调用 ngx_http_top_body_filter 进行响应</span></span><br><span class="line">    rc = ngx_http_lua_send_chain_link(r, ctx, cl);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (rc == NGX_ERROR || rc &gt;= NGX_HTTP_SPECIAL_RESPONSE) &#123;</span><br><span class="line">        lua_pushnil(L);</span><br><span class="line">        lua_pushliteral(L, <span class="string">&quot;nginx output filter error&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    dd(<span class="string">&quot;downstream write: %d, buf len: %d&quot;</span>, (<span class="type">int</span>) rc,</span><br><span class="line">       (<span class="type">int</span>) (b-&gt;last - b-&gt;pos));</span><br><span class="line"></span><br><span class="line">    lua_pushinteger(L, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-ngx-say"><a href="#3-ngx-say" class="headerlink" title="3. ngx.say"></a>3. <code>ngx.say</code></h3><p>函数原型：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ok, err = ngx.say(...)</span><br></pre></td></tr></table></figure>

<p>与 <code>ngx.print</code> 功能相同，最终会调用 <code>ngx_http_lua_ngx_echo</code> 函数，只不过 <code>ngx.say</code> 调用时 <code>newline</code> 参数为 <code>1</code>。</p>
<h3 id="4-ngx-flush"><a href="#4-ngx-flush" class="headerlink" title="4. ngx.flush"></a>4. <code>ngx.flush</code></h3><p>函数原型：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ok, err = ngx.<span class="built_in">flush</span>(wait?)</span><br></pre></td></tr></table></figure>

<p>允许介入阶段：<code>rewrite_by_lua_*</code>、<code>access_by_lua_*</code>、<code>content_by_lua_*</code>。</p>
<p>如果存在可选 <code>wait</code> 参数，并且值为 <code>true</code> 函数调用会等待发送结束或超时才返回（HTTP/1.0 buffing 未在此情况），否则立即返回。<code>ngx.flush</code> 实现函数 <code>ngx_http_lua_ngx_flush</code> 主要实现两个功能：<code>body filter</code> 链对应答数据进行处理、将应答数据发送出去，函数实现如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span></span><br><span class="line"><span class="title function_">ngx_http_lua_ngx_flush</span><span class="params">(lua_State *L)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">ngx_http_request_t</span>          *r;</span><br><span class="line">    <span class="type">ngx_http_lua_ctx_t</span>          *ctx;</span><br><span class="line">    <span class="type">ngx_chain_t</span>                 *cl;</span><br><span class="line">    <span class="type">ngx_int_t</span>                    rc;</span><br><span class="line">    <span class="type">int</span>                          n;</span><br><span class="line">    <span class="type">unsigned</span>                     wait = <span class="number">0</span>;</span><br><span class="line">    <span class="type">ngx_event_t</span>                 *wev;</span><br><span class="line">    <span class="type">ngx_http_core_loc_conf_t</span>    *clcf;</span><br><span class="line">    <span class="type">ngx_http_lua_co_ctx_t</span>       *coctx;</span><br><span class="line"></span><br><span class="line">    n = lua_gettop(L);</span><br><span class="line">    <span class="keyword">if</span> (n &gt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> luaL_error(L, <span class="string">&quot;attempt to pass %d arguments, but accepted 0 &quot;</span></span><br><span class="line">                          <span class="string">&quot;or 1&quot;</span>, n);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    r = ngx_http_lua_get_req(L);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (n == <span class="number">1</span> &amp;&amp; r == r-&gt;main) &#123;</span><br><span class="line">        luaL_checktype(L, <span class="number">1</span>, LUA_TBOOLEAN);</span><br><span class="line">        wait = lua_toboolean(L, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ctx = ngx_http_get_module_ctx(r, ngx_http_lua_module);</span><br><span class="line">    <span class="keyword">if</span> (ctx == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> luaL_error(L, <span class="string">&quot;no request ctx found&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_http_lua_check_context(L, ctx, NGX_HTTP_LUA_CONTEXT_REWRITE</span><br><span class="line">                               | NGX_HTTP_LUA_CONTEXT_ACCESS</span><br><span class="line">                               | NGX_HTTP_LUA_CONTEXT_CONTENT);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// </span></span><br><span class="line">    <span class="keyword">if</span> (ctx-&gt;acquired_raw_req_socket) &#123;</span><br><span class="line">        lua_pushnil(L);</span><br><span class="line">        lua_pushliteral(L, <span class="string">&quot;raw request socket acquired&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    coctx = ctx-&gt;cur_co_ctx;</span><br><span class="line">    <span class="keyword">if</span> (coctx == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> luaL_error(L, <span class="string">&quot;no co ctx found&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;header_only) &#123;</span><br><span class="line">        lua_pushnil(L);</span><br><span class="line">        lua_pushliteral(L, <span class="string">&quot;header only&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 请求已经关闭</span></span><br><span class="line">    <span class="keyword">if</span> (ctx-&gt;eof) &#123;</span><br><span class="line">        lua_pushnil(L);</span><br><span class="line">        lua_pushliteral(L, <span class="string">&quot;seen eof&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果是 buffing 则 flush 无效</span></span><br><span class="line">    <span class="keyword">if</span> (ctx-&gt;buffering) &#123;</span><br><span class="line">        ngx_log_debug0(NGX_LOG_DEBUG_HTTP, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                       <span class="string">&quot;lua http 1.0 buffering makes ngx.flush() a no-op&quot;</span>);</span><br><span class="line"></span><br><span class="line">        lua_pushnil(L);</span><br><span class="line">        lua_pushliteral(L, <span class="string">&quot;buffering&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> 1</span></span><br><span class="line">    <span class="comment">// header 已经发出、无待发送包体</span></span><br><span class="line">    <span class="keyword">if</span> ((!r-&gt;header_sent &amp;&amp; !ctx-&gt;header_sent)</span><br><span class="line">        || (!ctx-&gt;seen_body_data &amp;&amp; !wait))</span><br><span class="line">    &#123;</span><br><span class="line">        lua_pushnil(L);</span><br><span class="line">        lua_pushliteral(L, <span class="string">&quot;nothing to flush&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 使用空闲或新建 chain，并设置 flush 标记位；其中无待发送数据</span></span><br><span class="line">    cl = ngx_http_lua_get_flush_chain(r, ctx);</span><br><span class="line">    <span class="keyword">if</span> (cl == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> luaL_error(L, <span class="string">&quot;no memory&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 发送应答动作，经过 body filter 处理</span></span><br><span class="line">    <span class="comment">// 此时数据并未发送到客户端，仍然在 nginx 中，保存在 cl 中</span></span><br><span class="line">    rc = ngx_http_lua_send_chain_link(r, ctx, cl);</span><br><span class="line"></span><br><span class="line">    dd(<span class="string">&quot;send chain: %d&quot;</span>, (<span class="type">int</span>) rc);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (rc == NGX_ERROR || rc &gt;= NGX_HTTP_SPECIAL_RESPONSE) &#123;</span><br><span class="line">        lua_pushnil(L);</span><br><span class="line">        lua_pushliteral(L, <span class="string">&quot;nginx output filter error&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    dd(<span class="string">&quot;wait:%d, rc:%d, buffered:0x%x&quot;</span>, wait, (<span class="type">int</span>) rc,</span><br><span class="line">       r-&gt;connection-&gt;buffered);</span><br><span class="line"></span><br><span class="line">    wev = r-&gt;connection-&gt;write;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 同步写操作</span></span><br><span class="line">    <span class="comment">// 等待所有的数据写到客户端后才返回，并不会阻塞请求</span></span><br><span class="line">    <span class="keyword">if</span> (wait &amp;&amp; (r-&gt;connection-&gt;buffered &amp; NGX_HTTP_LOWLEVEL_BUFFERED</span><br><span class="line">                 || wev-&gt;delayed))</span><br><span class="line">    &#123;</span><br><span class="line">        ngx_log_debug2(NGX_LOG_DEBUG_HTTP, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                       <span class="string">&quot;lua flush requires waiting: buffered 0x%uxd, &quot;</span></span><br><span class="line">                       <span class="string">&quot;delayed:%d&quot;</span>, (<span class="type">unsigned</span>) r-&gt;connection-&gt;buffered,</span><br><span class="line">                       wev-&gt;delayed);</span><br><span class="line"></span><br><span class="line">        coctx-&gt;flushing = <span class="number">1</span>;</span><br><span class="line">        ctx-&gt;flushing_coros++;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ctx-&gt;entered_content_phase) &#123;</span><br><span class="line">            <span class="comment">/* mimic ngx_http_set_write_handler */</span></span><br><span class="line">            r-&gt;write_event_handler = ngx_http_lua_content_wev_handler;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            r-&gt;write_event_handler = ngx_http_core_run_phases;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        clcf = ngx_http_get_module_loc_conf(r, ngx_http_core_module);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!wev-&gt;delayed) &#123;</span><br><span class="line">            ngx_add_timer(wev, clcf-&gt;send_timeout);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ngx_handle_write_event(wev, clcf-&gt;send_lowat) != NGX_OK) &#123;</span><br><span class="line">            <span class="keyword">if</span> (wev-&gt;timer_set) &#123;</span><br><span class="line">                wev-&gt;delayed = <span class="number">0</span>;</span><br><span class="line">                ngx_del_timer(wev);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            lua_pushnil(L);</span><br><span class="line">            lua_pushliteral(L, <span class="string">&quot;connection broken&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ngx_http_lua_cleanup_pending_operation(ctx-&gt;cur_co_ctx);</span><br><span class="line">        coctx-&gt;cleanup = ngx_http_lua_flush_cleanup;</span><br><span class="line">        coctx-&gt;data = r;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> lua_yield(L, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ngx_log_debug0(NGX_LOG_DEBUG_HTTP, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                   <span class="string">&quot;lua flush asynchronously&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 异步发送，不等待发送结束，仅设置 chain 的 flush 标记位</span></span><br><span class="line">    lua_pushinteger(L, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 <code>ngx.print</code>、<code>ngx.say</code>、<code>ngx.flush</code> 函数实现中都会调用 <code>ngx_http_lua_send_chain_link</code> 函数，用于将应答数据经过 <code>header filter</code>、<code>body filter</code> 处理。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将应答数据经过 body filter 处理</span></span><br><span class="line"><span class="type">ngx_int_t</span></span><br><span class="line"><span class="title function_">ngx_http_lua_send_chain_link</span><span class="params">(<span class="type">ngx_http_request_t</span> *r, <span class="type">ngx_http_lua_ctx_t</span> *ctx,</span></span><br><span class="line"><span class="params">    <span class="type">ngx_chain_t</span> *in)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">ngx_int_t</span>                     rc;</span><br><span class="line">    <span class="type">ngx_chain_t</span>                  *cl;</span><br><span class="line">    <span class="type">ngx_chain_t</span>                 **ll;</span><br><span class="line">    <span class="type">ngx_http_lua_loc_conf_t</span>      *llcf;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> 1</span></span><br><span class="line">    <span class="keyword">if</span> (ctx-&gt;acquired_raw_req_socket || ctx-&gt;eof) &#123;</span><br><span class="line">        dd(<span class="string">&quot;ctx-&gt;eof already set or raw req socket already acquired&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((r-&gt;method &amp; NGX_HTTP_HEAD) &amp;&amp; !r-&gt;header_only) &#123;</span><br><span class="line">        r-&gt;header_only = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    llcf = ngx_http_get_module_loc_conf(r, ngx_http_lua_module);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (llcf-&gt;http10_buffering</span><br><span class="line">        &amp;&amp; !ctx-&gt;buffering</span><br><span class="line">        &amp;&amp; !r-&gt;header_sent</span><br><span class="line">        &amp;&amp; !ctx-&gt;header_sent</span><br><span class="line">        &amp;&amp; r-&gt;http_version &lt; NGX_HTTP_VERSION_11</span><br><span class="line">        &amp;&amp; r-&gt;headers_out.content_length_n &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        ctx-&gt;buffering = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    rc = ngx_http_lua_send_header_if_needed(r, ctx);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (rc == NGX_ERROR || rc &gt; NGX_OK) &#123;</span><br><span class="line">        <span class="keyword">return</span> rc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 仅需要发送 header，无 body</span></span><br><span class="line">    <span class="keyword">if</span> (r-&gt;header_only) &#123;</span><br><span class="line">        ctx-&gt;eof = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ctx-&gt;buffering) &#123;</span><br><span class="line">            <span class="keyword">return</span> ngx_http_lua_send_http10_headers(r, ctx);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> rc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (in == <span class="literal">NULL</span>) &#123;</span><br><span class="line">        dd(<span class="string">&quot;last buf to be sent&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> 1</span></span><br><span class="line">        <span class="keyword">if</span> (!r-&gt;request_body &amp;&amp; r == r-&gt;main) &#123;</span><br><span class="line">            <span class="keyword">if</span> (ngx_http_discard_request_body(r) != NGX_OK) &#123;</span><br><span class="line">                <span class="keyword">return</span> NGX_ERROR;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (ctx-&gt;buffering) &#123;</span><br><span class="line">            rc = ngx_http_lua_send_http10_headers(r, ctx);</span><br><span class="line">            <span class="keyword">if</span> (rc == NGX_ERROR || rc &gt;= NGX_HTTP_SPECIAL_RESPONSE) &#123;</span><br><span class="line">                <span class="keyword">return</span> rc;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (ctx-&gt;out) &#123;</span><br><span class="line"></span><br><span class="line">                rc = ngx_http_lua_output_filter(r, ctx-&gt;out);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (rc == NGX_ERROR || rc &gt;= NGX_HTTP_SPECIAL_RESPONSE) &#123;</span><br><span class="line">                    <span class="keyword">return</span> rc;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                ctx-&gt;out = <span class="literal">NULL</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(nginx_version) &amp;&amp; nginx_version &lt;= 8004</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* earlier versions of nginx does not allow subrequests</span></span><br><span class="line"><span class="comment">           to send last_buf themselves */</span></span><br><span class="line">        <span class="keyword">if</span> (r != r-&gt;main) &#123;</span><br><span class="line">            <span class="keyword">return</span> NGX_OK;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">        ctx-&gt;eof = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        ngx_log_debug0(NGX_LOG_DEBUG_HTTP, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                       <span class="string">&quot;lua sending last buf of the response body&quot;</span>);</span><br><span class="line"></span><br><span class="line">        rc = ngx_http_lua_send_special(r, NGX_HTTP_LAST);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (rc == NGX_ERROR || rc &gt;= NGX_HTTP_SPECIAL_RESPONSE) &#123;</span><br><span class="line">            <span class="keyword">return</span> rc;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* in != NULL */</span></span><br><span class="line">    <span class="comment">// 存在 buffing 数据，将待发送数据放在最后</span></span><br><span class="line">    <span class="keyword">if</span> (ctx-&gt;buffering) &#123;</span><br><span class="line">        ngx_log_debug0(NGX_LOG_DEBUG_HTTP, r-&gt;connection-&gt;<span class="built_in">log</span>, <span class="number">0</span>,</span><br><span class="line">                       <span class="string">&quot;lua buffering output bufs for the HTTP 1.0 request&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将 ctx 中待发送数据保存到 ngx_chain_t 中</span></span><br><span class="line">        <span class="keyword">for</span> (cl = ctx-&gt;out, ll = &amp;ctx-&gt;out; cl; cl = cl-&gt;next) &#123;</span><br><span class="line">            ll = &amp;cl-&gt;next;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        *ll = in;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> NGX_OK;</span><br><span class="line">    &#125;</span><br><span class="line">		<span class="comment">// 调用 ngx_http_output_filter 进行 body filter 处理</span></span><br><span class="line">    <span class="keyword">return</span> ngx_http_lua_output_filter(r, in);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-ngx-eof"><a href="#5-ngx-eof" class="headerlink" title="5. ngx.eof"></a>5. <code>ngx.eof</code></h3><p>函数原型：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ok, err = ngx.eof()</span><br></pre></td></tr></table></figure>

<p>允许介入阶段：<code>rewrite_by_lua_*</code>、<code>access_by_lua_*</code>、<code>content_by_lua_*</code>。</p>
<p>指示响应流结束，如果是 <code>HTTP/1.1</code> 版本 <code>chunked</code> 编码格式，将触发发送最后一个 <code>chunk</code>。如果未启用 <code>HTTP/1.1</code> 的 <code>keep-alive</code> 特性，调用 <code>ngx.eof</code> 后客户端应该关闭连接。**<code>ngx.eof</code> 不会关闭连接，只会调用 <code>header filter</code>、<code>body filter</code> 进行应答处理**。</p>
<p>在 <code>ngx.eof</code> 实现中同样会调用 <code>ngx_http_lua_send_chain_link</code>。</p>
<h2 id="三-HTTP-1-0-buffing"><a href="#三-HTTP-1-0-buffing" class="headerlink" title="三 HTTP/1.0 buffing"></a>三 HTTP/1.0 buffing</h2><p><code>HTTP/1.0</code> 不支持 <code>chunked</code> 编码，当响应 <code>body</code> 不为空时需要 <code>content-length</code> 头以便支持 <code>HTTP/1.0</code> 的 <code>keep-alive</code> 特性。因此当发起 <code>HTTP/1.0</code> 协议请求并且打开了 <code>lua_http10_buffing</code> 配置时，<code>lua-nginx</code> 模块会将 <code>ngx.say</code>、<code>ngx.print</code> 的输出内容缓存（同时会将应答 <code>header</code> 延时发送），直到收到所有的应答 <code>body</code>。此时，<code>lua-nginx</code> 模块就能计算出 <code>content-length</code> 并发送给客户端。如果在应答头中有 <code>content-length</code> 头，即使打开了 <code>lua_http10_buffing</code> 也不会缓存应答信息。</p>
<p>对于大的响应流，要注意关闭 <code>lua_http10_buffing</code> 指令，避免内存占用过高。</p>
<h3 id="1-lua-http10-buffering-指令"><a href="#1-lua-http10-buffering-指令" class="headerlink" title="1. lua_http10_buffering 指令"></a>1. <code>lua_http10_buffering</code> 指令</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">syntax: lua_http10_buffering on|off</span><br><span class="line">default: lua_http10_buffering on</span><br><span class="line">context: http, server, location, location-if</span><br></pre></td></tr></table></figure>

<p>为 <code>HTTP/1.0</code> (或更老的)请求启用或禁用自动响应缓存，这种缓冲机制主要用于低于 <code>HTTP/1.0</code> 版本的 <code>keep-alive</code> 特性，它依赖于正确的 <code>content-length</code> 响应头。</p>
<p>如果 <code>lua</code> 代码在发送响应头（通过调用 <code>ngx.send_headers</code>、<code>ngx.say</code>、<code>ngx.print</code> 触发发送响应头）之前已经显示的设置 <code>content-length</code> 头，<code>http10_buffering</code> 特性将被关闭。</p>

        </div>
        

    </article>
    
    <section id="comments">
        
    </section>


    

</main>


<aside style="" id="sidebar" class="aside aside-fixture">
    <div class="toc-sidebar">
        <nav id="toc" class="article-toc">
            <h3 class="toc-title">文章目录</h3>
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80-%E6%A6%82%E8%BF%B0"><span class="toc-number">1.</span> <span class="toc-text">一 概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C-%E8%BE%93%E5%87%BA%E5%87%BD%E6%95%B0"><span class="toc-number">2.</span> <span class="toc-text">二 输出函数</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-ngx-send-headers"><span class="toc-number">2.1.</span> <span class="toc-text">1. ngx.send_headers</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-ngx-print"><span class="toc-number">2.2.</span> <span class="toc-text">2. ngx.print</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-ngx-say"><span class="toc-number">2.3.</span> <span class="toc-text">3. ngx.say</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-ngx-flush"><span class="toc-number">2.4.</span> <span class="toc-text">4. ngx.flush</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-ngx-eof"><span class="toc-number">2.5.</span> <span class="toc-text">5. ngx.eof</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89-HTTP-1-0-buffing"><span class="toc-number">3.</span> <span class="toc-text">三 HTTP&#x2F;1.0 buffing</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-lua-http10-buffering-%E6%8C%87%E4%BB%A4"><span class="toc-number">3.1.</span> <span class="toc-text">1. lua_http10_buffering 指令</span></a></li></ol></li></ol>
        </nav>
    </div>
</aside>





        </section>
        <footer class="hidden lg:block fixed bottom-0 left-0 sm:w-1/12 lg:w-1/6 bg-gray-100 z-40">
    
    <div class="footer-social-links">
        
            <a target="_blank" rel="noopener" href="https://github.com/juzipeek">
                <i class="iconfont icon-github"></i>
            </a>
        
    </div>
    
    
</footer>

        <div id="mask" class="hidden mask fixed inset-0 bg-gray-900 opacity-75 z-40"></div>
        <div id="search-view-container" class="hidden shadow-xl"></div>
        
<script src="/js/dom-event.min.js"></script>



<script src="/js/local-search.min.js"></script>



    <script src="//cdn.jsdelivr.net/npm/lightgallery.js@1.1.3/dist/js/lightgallery.min.js"></script>
    
<script src="/js/light-gallery.min.js"></script>






    </body>
</html>
